{% extends "lab/base.html" %}
{% load static %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –ü–æ–¥–±–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .attempts-counter {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .attempts-icon {
            font-size: 1.5rem;
        }

        .attempts-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .attempts-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: #f87171;
        }

        .main-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(245, 158, 11, 0.15));
            border-radius: 12px;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .control-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .slider-panel {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 2rem;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .slider-panel.top {
            order: 1;
        }

        .slider-panel.bottom {
            order: 3;
        }

        @media (max-width: 900px) {
            .slider-panel {
                flex-direction: column;
                gap: 1.5rem;
            }
        }

        .slider-group {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 120px;
        }

        .slider-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .horizontal-slider {
            width: 100%;
            height: 20px;
            appearance: none;
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.7), rgba(245, 158, 11, 0.7), rgba(239, 68, 68, 0.7));
            border-radius: 10px;
            cursor: pointer;
            margin: 0.5rem 0;
        }

        .horizontal-slider::-webkit-slider-thumb {
            appearance: none;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .horizontal-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 50%;
            cursor: grab;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .map-container {
            order: 2;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0;
        }

        #imageCanvas {
            border-radius: 16px;
            border: 4px solid var(--bg-secondary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: none;
            height: auto;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        .output-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .output-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .output-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: #fbbf24;
        }

        .output-details {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .output-detail {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .output-detail strong {
            color: var(--accent-cyan);
        }

        .calculate-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.7), rgba(245, 158, 11, 0.7));
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8), rgba(245, 158, 11, 0.8));
        }

        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .results-scroll {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .results-table {
            width: 100%;
            min-width: 500px;
            border-collapse: separate;
            border-spacing: 0;
        }

        .results-table th,
        .results-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table td:first-child {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            color: white;
            font-weight: 600;
            text-align: left;
            padding-left: 1.25rem;
            white-space: nowrap;
        }

        .results-table td {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        .fio-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        .fio-section.show {
            display: block;
        }

        .fio-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: block;
        }

        .fio-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .fio-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .submit-btn {
            display: none;
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #22c55e, #10b981);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn.show {
            display: block;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
    </style>
{% endblock head %}

{% block content %}
    <div class="status-bar">
        <div class="attempts-counter">
            <span class="attempts-icon">üéØ</span>
            <div>
                <div class="attempts-label">–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫</div>
                <div class="attempts-value" id="attemptsValue">5</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 100px; color: #f87171; font-size: 0.85rem;">
            ‚òÑÔ∏è –ü–æ—è—Å –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤!
        </div>
    </div>

    <div class="main-panel">
        <div class="panel-header">
            <div class="panel-icon">üó∫Ô∏è</div>
            <div class="panel-title">–ö–∞—Ä—Ç–∞ –∞—Å—Ç–µ—Ä–æ–∏–¥–Ω–æ–≥–æ –ø–æ–ª—è</div>
        </div>

        <div class="control-area">
            <div class="slider-panel top">
                <div class="slider-group">
                    <div class="slider-label">X‚ÇÅ</div>
                    <input type="range" id="x1Slider" class="horizontal-slider" min="0" max="149" value="0">
                    <div class="slider-value" id="x1Value">0</div>
                </div>
            </div>

            <div class="map-container">
                <canvas id="imageCanvas"></canvas>
            </div>

            <div class="slider-panel bottom">
                <div class="slider-group">
                    <div class="slider-label">X‚ÇÇ</div>
                    <input type="range" id="x2Slider" class="horizontal-slider" min="0" max="149" value="149">
                    <div class="slider-value" id="x2Value">149</div>
                </div>
            </div>
        </div>

        <button id="button" class="calculate-btn">‚ö° –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é</button>

        <div class="output-section" id="totalPoints">
            <div class="output-title">–ò—Ç–æ–≥–æ–≤—ã–µ –æ—á–∫–∏</div>
            <div class="output-value">0</div>
        </div>
    </div>

    <div class="results-panel">
        <div class="panel-header">
            <div class="panel-icon">üìä</div>
            <div class="panel-title">–ñ—É—Ä–Ω–∞–ª –ø–æ–ª—ë—Ç–æ–≤</div>
        </div>

        <form id="tableForm" method="POST" action="">
            {% csrf_token %}
            <div class="results-scroll">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>–ü–æ–ø—ã—Ç–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>X‚ÇÅ</td></tr>
                        <tr><td>X‚ÇÇ</td></tr>
                        <tr><td>–°—Ç–∞–Ω—Ü–∏–∏</td></tr>
                        <tr><td>–¢–æ–ø–ª–∏–≤–æ</td></tr>
                        <tr><td>–û—á–∫–∏</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="empty-state" id="emptyState">
                <p>üì≠ –ó–∞–ø—É—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>

            <input type="hidden" name="table_data" id="tableDataInput"/>

            <div class="fio-section" id="fioSection">
                <label class="fio-label">–¢–≤–æ—ë –§–ò–û –¥–ª—è –æ—Ç—á—ë—Ç–∞</label>
                <input type="text" name="text" class="fio-input" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –º–∏—Å—Å–∏—é</button>
        </form>
    </div>

    <script>
        let attemptsLeft = 5;

        function updateAttemptsDisplay() {
            document.getElementById('attemptsValue').textContent = attemptsLeft;
        }

        function addColumn(values) {
            const table = document.getElementById("resultsTable");
            const headerRow = table.querySelector("thead tr");
            const rows = table.querySelectorAll("tbody tr");

            const newHeaderCell = document.createElement("th");
            const columnIndex = headerRow.children.length;
            newHeaderCell.textContent = columnIndex;
            headerRow.appendChild(newHeaderCell);

            values.forEach((value, index) => {
                const newCell = document.createElement("td");
                newCell.textContent = value;
                rows[index].appendChild(newCell);
            });

            document.getElementById('emptyState').style.display = 'none';

            attemptsLeft--;
            updateAttemptsDisplay();

            if (attemptsLeft === 0) {
                document.getElementById('button').disabled = true;
                document.getElementById('submitBtn').classList.add('show');
                document.getElementById('fioSection').classList.add('show');
            }
        }

        window.onload = function() {
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d');
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–∫–æ—Å—Ç–∏ –ø–∏–∫—Å–µ–ª–µ–π
            ctx.imageSmoothingEnabled = false;
            ctx.mozImageSmoothingEnabled = false;
            ctx.webkitImageSmoothingEnabled = false;
            ctx.msImageSmoothingEnabled = false;
            
            const x1Slider = document.getElementById('x1Slider');
            const x2Slider = document.getElementById('x2Slider');
            const button = document.getElementById('button');
            const x1ValueEl = document.getElementById('x1Value');
            const x2ValueEl = document.getElementById('x2Value');
            const totalPoints = document.getElementById('totalPoints');

            let img = new Image();
            let imgLoaded = false;
            let imageDataCache = null;
            let updateTimeout = null;
            
            img.src = '{% static "img/map_small.jpg" %}';
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                // –ö—ç—à–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                imageDataCache = ctx.getImageData(0, 0, canvas.width, canvas.height);
                imgLoaded = true;
                updateLine();
            };

            function updateLine() {
                if (!imgLoaded || !imageDataCache) return;
                
                const x1 = parseInt(x1Slider.value);
                const x2 = parseInt(x2Slider.value);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞
                const data = new Uint8ClampedArray(imageDataCache.data);

                const dx = Math.abs(x2 - x1);
                const dy = Math.abs(img.height - 1);
                const sx = x1 < x2 ? 1 : -1;
                const sy = 1;
                let err = dx - dy;
                let x = x1;
                let y = 0;

                while (true) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    const maxColorValue = Math.max(r, g, b);
                    if (maxColorValue === r) {
                        data[index] = 255;
                        data[index + 1] = 0;
                        data[index + 2] = 0;
                    } else if (maxColorValue === g) {
                        data[index] = 0;
                        data[index + 1] = 255;
                        data[index + 2] = 0;
                    } else {
                        data[index] = 255;
                        data[index + 1] = 255;
                        data[index + 2] = 255;
                    }

                    if (x === x2 && y === img.height - 1) break;
                    const e2 = 2 * err;
                    if (e2 > -dy) { err -= dy; x += sx; }
                    if (e2 < dx) { err += dx; y += sy; }
                }

                const newImageData = new ImageData(data, canvas.width, canvas.height);
                ctx.putImageData(newImageData, 0, 0);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
            let updatePending = false;
            
            function scheduleUpdate() {
                if (!updatePending) {
                    updatePending = true;
                    requestAnimationFrame(function() {
                        updateLine();
                        updatePending = false;
                    });
                }
            }

            x1Slider.addEventListener('input', function() {
                x1ValueEl.textContent = x1Slider.value;
                scheduleUpdate();
            });

            x2Slider.addEventListener('input', function() {
                x2ValueEl.textContent = x2Slider.value;
                scheduleUpdate();
            });

            button.addEventListener('click', function() {
                const x1 = parseInt(x1Slider.value);
                const x2 = parseInt(x2Slider.value);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                let sumRValue = 0, sumGValue = 0, sumBValue = 0;
                let blueIslands = 0;
                let insideBlueIsland = false;

                const dx = Math.abs(x2 - x1);
                const dy = Math.abs(canvas.height - 1);
                const sx = x1 < x2 ? 1 : -1;
                const sy = 1;
                let err = dx - dy;
                let x = x1;
                let y = 0;

                while (true) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    const maxColorValue = Math.max(r, g, b);
                    if (maxColorValue === b) {
                        sumBValue++;
                        if (!insideBlueIsland) {
                            blueIslands++;
                            insideBlueIsland = true;
                        }
                    } else if (maxColorValue === r) {
                        sumRValue++;
                        insideBlueIsland = false;
                    } else if (maxColorValue === g) {
                        sumGValue++;
                        insideBlueIsland = false;
                    } else {
                        insideBlueIsland = false;
                    }

                    if (x === x2 && y === canvas.height - 1) break;
                    const e2 = 2 * err;
                    if (e2 > -dy) { err -= dy; x += sx; }
                    if (e2 < dx) { err += dx; y += sy; }
                }

                const fuel = 150 + 2 * blueIslands - sumGValue - sumRValue * 2;
                let result, points;
                
                if (fuel < 0) {
                    result = '–ù–µ–¥–æ–ª—ë—Ç üí•';
                    points = 0;
                } else {
                    points = fuel + (sumBValue - 4) * 8;
                    result = points;
                }

                totalPoints.innerHTML = `
                    <div class="output-title">–ò—Ç–æ–≥–æ–≤—ã–µ –æ—á–∫–∏</div>
                    <div class="output-value">${result}</div>
                    <div class="output-details">
                        <div class="output-detail">üõ∞Ô∏è –°—Ç–∞–Ω—Ü–∏–π: <strong>${blueIslands}</strong></div>
                        <div class="output-detail">‚õΩ –¢–æ–ø–ª–∏–≤–æ: <strong>${fuel}</strong></div>
                    </div>
                `;

                addColumn([x1, x2, blueIslands, fuel, points]);
            });

            document.getElementById('tableForm').addEventListener('submit', function(event) {
                event.preventDefault();
                let csv_data = [];
                let rows = document.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    let cols = rows[i].querySelectorAll('td,th');
                    let csvrow = [];
                    for (let j = 0; j < cols.length; j++) {
                        csvrow.push(cols[j].innerHTML);
                    }
                    csv_data.push(csvrow.join(","));
                }
                
                csv_data = csv_data.join('\n');
                document.getElementById('tableDataInput').value = JSON.stringify(csv_data);
                this.submit();
            });
        };
    </script>
{% endblock content %}
