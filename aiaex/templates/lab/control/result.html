{% extends "lab/base.html" %}
{% load static %}

{% block head %}
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .results-hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 24px;
            margin-bottom: 2rem;
        }

        .results-hero-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .results-hero h1 {
            font-size: 2rem;
            color: #34d399;
            margin-bottom: 0.5rem;
        }

        .results-hero p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
        }

        .metric-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .map-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .map-panel h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        #imageCanvas {
            border-radius: 16px;
            border: 4px solid var(--bg-secondary);
            width: 100%;
            max-width: none;
            height: auto;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        .data-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .data-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .data-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(245, 158, 11, 0.15));
            border-radius: 10px;
        }

        .data-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .data-scroll {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td:first-child {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            color: white;
            font-weight: 600;
            text-align: left;
            padding-left: 1.25rem;
            white-space: nowrap;
        }

        .data-table td {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
        }

        /* Story Section */
        .story-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .story-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            user-select: none;
        }

        .story-toggle:hover {
            color: var(--accent-cyan);
        }

        .story-content {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .story-content.show {
            display: block;
        }

        .story-text {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .story-image {
            max-width: 500px;
            width: 100%;
            height: auto;
            border-radius: 16px;
            margin-bottom: 1.5rem;
        }

        .story-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .story-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .story-btn-primary {
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: white;
        }

        .story-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .story-btn:hover {
            transform: translateY(-2px);
        }

        .code-panel {
            display: none;
            margin-top: 1.5rem;
        }

        .code-panel.show {
            display: block;
        }

        .code-panel textarea {
            width: 100%;
            height: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            resize: vertical;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .action-btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
        }

        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.3);
            color: white;
        }

        .action-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .action-btn-secondary:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
    </style>
    <script>
        function toggleStory() {
            const content = document.getElementById('storyContent');
            const icon = document.getElementById('toggleIcon');
            content.classList.toggle('show');
            icon.textContent = content.classList.contains('show') ? '‚ñº' : '‚ñ∂';
        }

        function toggleCode() {
            const content = document.getElementById('codePanel');
            content.classList.toggle('show');
        }

        function handleFirstOption() {
            document.getElementById('storyText').textContent = '–î–∞... –Ø –ø–æ–Ω—è–ª–∞, –∫–∞–ø–∏—Ç–∞–Ω... –û–±–µ—â–∞—é, —á—Ç–æ —Ç–∞–∫–æ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è... –ü–æ–∂–∞–ª—É–π —è –ø–æ–π–¥—É...';
            document.getElementById('storyImage').src = '{% static "img/sad.png" %}';
            document.getElementById('storyButtons').innerHTML = '';
        }

        function handleSecondOption() {
            document.getElementById('storyText').textContent = '–°–ø–∞—Å–∏–±–æ –≤–∞–º –æ–≥—Ä–æ–º–Ω–æ–µ... –ò –∑–Ω–∞–µ—Ç–µ.. –í —á–µ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—à–µ–π –º–∏—Å—Å–∏–∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞ –¥–ª—è –≤–∞—Å –∫–æ–µ-—á—Ç–æ. –ü—É—Å—Ç—å —ç—Ç–æ —Å–æ–≤—Å–µ–º –º–µ–ª–æ—á—å, –Ω–æ –º–Ω–µ –±—ã–ª–æ –≤–∞–∂–Ω–æ –∫–∞–∫-—Ç–æ –æ—Ç–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –≤–∞—Å!';
            document.getElementById('storyImage').src = '{% static "img/paper.png" %}';
            document.getElementById('storyButtons').innerHTML = '<button class="story-btn story-btn-primary" onclick="handleNext()">üìÑ –í–∑—è—Ç—å –æ—Ç—á—ë—Ç</button>';
            // Show code button after accepting apologies
            const codeButtonContainer = document.getElementById('codeButtonContainer');
            if (codeButtonContainer) {
                codeButtonContainer.style.display = 'block';
            }
        }

        function handleNext() {
            document.getElementById('storyText').textContent = '–°–ø–∞—Å–∏–±–æ –≤–∞–º –æ–≥—Ä–æ–º–Ω–æ–µ –∑–∞ —ç—Ç—É –º–∏—Å—Å–∏—é. –Ø –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å–∫–∞–∂—É –†–æ–º–∞–Ω—É –í–∏–∫—Ç–æ—Ä–æ–≤–∏—á—É –æ–±–æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø–æ–¥–≤–∏–≥–∞—Ö! –ö–∞–ø–∏—Ç–∞–Ω {{ fio }}';
            document.getElementById('storyImage').src = '{% static "img/bye.png" %}';
            document.getElementById('storyButtons').innerHTML = '';
            
            // Download file
            const link = document.createElement('a');
            link.href = "{{ file }}";
            link.download = "report.txt";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = function() {
            const canvas = document.getElementById('imageCanvas');
            const ctx = canvas.getContext('2d');
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∑–∫–æ—Å—Ç–∏ –ø–∏–∫—Å–µ–ª–µ–π
            ctx.imageSmoothingEnabled = false;
            ctx.mozImageSmoothingEnabled = false;
            ctx.webkitImageSmoothingEnabled = false;
            ctx.msImageSmoothingEnabled = false;

            let img = new Image();
            img.src = '{% static "img/map_small.jpg" %}';
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                updateLine();
            };

            function updateLine() {
                const x1 = parseInt({{ x1 }});
                const x2 = parseInt({{ x2 }});

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                const dx = Math.abs(x2 - x1);
                const dy = Math.abs(img.height - 1);
                const sx = x1 < x2 ? 1 : -1;
                const sy = 1;
                let err = dx - dy;
                let x = x1;
                let y = 0;

                while (true) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    const maxColorValue = Math.max(r, g, b);
                    if (maxColorValue === r) {
                        data[index] = 255;
                        data[index + 1] = 0;
                        data[index + 2] = 0;
                    } else if (maxColorValue === g) {
                        data[index] = 0;
                        data[index + 1] = 255;
                        data[index + 2] = 0;
                    } else {
                        data[index] = 255;
                        data[index + 1] = 255;
                        data[index + 2] = 255;
                    }

                    if (x === x2 && y === img.height - 1) break;
                    const e2 = 2 * err;
                    if (e2 > -dy) { err -= dy; x += sx; }
                    if (e2 < dx) { err += dx; y += sy; }
                }

                ctx.putImageData(imageData, 0, 0);
            }
        };
    </script>
{% endblock head %}

{% block content %}
    <div class="results-hero">
        <div class="results-hero-icon">üéâ</div>
        <h1>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –∫–∞–ø–∏—Ç–∞–Ω!</h1>
        <p>–ù–∞–º —É–¥–∞–ª–æ—Å—å –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é –ø–æ–ª—ë—Ç–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –¥–æ–º–æ–π. –ö–æ—Ä–∞–±–ª—å —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–æ–¥–æ–ª–µ–ª –ø–æ—è—Å –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤!</p>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üìç</div>
            <div class="metric-value">{{ x1 }}</div>
            <div class="metric-label">X‚ÇÅ</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üìç</div>
            <div class="metric-value">{{ x2 }}</div>
            <div class="metric-label">X‚ÇÇ</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üõ∞Ô∏è</div>
            <div class="metric-value">{{ sv }}</div>
            <div class="metric-label">–°—Ç–∞–Ω—Ü–∏–π</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">‚õΩ</div>
            <div class="metric-value">{{ fuel }}</div>
            <div class="metric-label">–¢–æ–ø–ª–∏–≤–æ</div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">üèÜ</div>
            <div class="metric-value">{{ mx }}</div>
            <div class="metric-label">–û—á–∫–∏</div>
        </div>
    </div>

    <div class="map-panel">
        <h3>üó∫Ô∏è –õ—É—á—à–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è ‚Äî {{ tr }}</h3>
        <canvas id="imageCanvas"></canvas>
    </div>

    <div class="data-panel">
        <div class="data-header">
            <div class="data-icon">üìä</div>
            <div class="data-title">–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏</div>
        </div>
        <div class="data-scroll">
            <table class="data-table">
                <tr>
                    <td>–ü–æ–ø—ã—Ç–∫–∞</td>
                    {% for i in table.0 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>X‚ÇÅ</td>
                    {% for i in table.1 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>X‚ÇÇ</td>
                    {% for i in table.2 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>–°—Ç–∞–Ω—Ü–∏–∏</td>
                    {% for i in table.3 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>–¢–æ–ø–ª–∏–≤–æ</td>
                    {% for i in table.4 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>–û—á–∫–∏</td>
                    {% for i in table.5 %}
                        <td>{{ i }}</td>
                    {% endfor %}
                </tr>
            </table>
        </div>
    </div>

    <div class="story-panel">
        <div class="story-toggle" onclick="toggleStory()">
            <span id="toggleIcon">‚ñ∂</span>
            üé≠ –í–∞–∂–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç –ø–æ–º–æ—â–Ω–∏–∫–∞
        </div>
        <div class="story-content" id="storyContent">
            <p class="story-text" id="storyText">
                –ö-–∫–∞–ø–∏—Ç–∞–Ω... –¢—É—Ç —Ç–∞–∫–æ–µ –¥–µ–ª–æ... –°–µ–π—á–∞—Å –±—ã–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–æ—Ä–∞–±–ª—è –∏ –æ–∫–∞–∑–∞–ª–æ—Å—å —á—Ç–æ... 
                –í—Å–µ —ç—Ç–∏ –Ω–µ–ø–æ–ª–∞–¥–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø–æ–ª–µ—Ç–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ —è –∑–∞–±—ã–ª–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–¥–∏–Ω 
                –Ω–µ–±–æ–ª—å—à–æ–π –õ–∞–±–ö–∏–±-–º–æ–¥—É–ª—å... –ü—Ä–æ—Å—Ç–∏—Ç–µ! –ü—Ä–æ—Å—Ç–∏—Ç–µ –º–µ–Ω—è –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! –Ø –Ω–µ —Ö–æ—Ç–µ–ª–∞...
            </p>
            <img id="storyImage" class="story-image" src="{% static 'img/sorry.png' %}" alt="–ü–æ–º–æ—â–Ω–∏–∫">
            <div class="story-buttons" id="storyButtons">
                <button class="story-btn story-btn-secondary" onclick="handleFirstOption()">üò§ –ù–∞–∫—Ä–∏—á–∞—Ç—å</button>
                <button class="story-btn story-btn-primary" onclick="handleSecondOption()">ü§ù –ü—Ä–∏–Ω—è—Ç—å –∏–∑–≤–∏–Ω–µ–Ω–∏—è</button>
            </div>
            
            <div style="margin-top: 1.5rem; display: none;" id="codeButtonContainer">
                <button class="story-btn story-btn-secondary" onclick="toggleCode()">üìù –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ –æ—Ç—á—ë—Ç–∞</button>
            </div>
            <div class="code-panel" id="codePanel">
                <textarea readonly>{{ tx }}</textarea>
            </div>
        </div>
    </div>

    <div class="actions">
        <a href="/labkib/legacy/control/" class="action-btn action-btn-secondary" onclick="if(window.top !== window.self) { window.top.location.href = this.href; return false; }">
            ‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </a>
        <a href="/labkib/" class="action-btn action-btn-primary" onclick="if(window.top !== window.self) { window.top.location.href = this.href; return false; }">
            üè† –ö —Å–ø–∏—Å–∫—É —Ä–∞–±–æ—Ç
        </a>
    </div>
{% endblock content %}
