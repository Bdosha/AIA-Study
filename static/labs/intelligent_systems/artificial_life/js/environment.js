/**
 * –§–∞–π–ª: environment.js
 * –û–ø–∏—Å–∞–Ω–∏–µ: –ö–ª–∞—Å—Å —Å—Ä–µ–¥—ã —Å–∏–º—É–ª—è—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã
 * 
 * Environment - —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–∏–º—É–ª—è—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π:
 * - –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏ (—Ç—Ä–∞–≤–æ—è–¥–Ω—ã–µ –∏ —Ö–∏—â–Ω–∏–∫–∏)
 * - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (–µ–¥–∞)
 * - –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å—Ä–µ–¥—ã (–ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, —è–¥)
 * - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –ø–æ–ø—É–ª—è—Ü–∏–∏
 * - –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ–∫–æ–ª–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
 * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è –≤—ã–º–∏—Ä–∞–Ω–∏—è
 * - –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –≤—Å—é —Å–∏–º—É–ª—è—Ü–∏—é –Ω–∞ canvas
 * 
 * –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä):
 * 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ (behave)
 * 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–∑–∏–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤ (update)
 * 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
 * 4. –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏)
 * 5. –£–¥–∞–ª–µ–Ω–∏–µ –º—ë—Ä—Ç–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
 * 6. –°–ø–∞–≤–Ω –Ω–æ–≤–æ–π –µ–¥—ã
 * 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ–Ω—É –ø–æ–∫–æ–ª–µ–Ω–∏—è
 * 
 * @author –í–∞—à–µ –∏–º—è
 * @version 1.0
 */

import { Agent, Herbivore, Predator, Food, Obstacle, Poison } from './agent.js';
import { Vector2D } from './vector2d.js';
import { CONFIG } from './config.js';

/**
 * –ö–ª–∞—Å—Å –æ–∫—Ä—É–∂–∞—é—â–µ–π —Å—Ä–µ–¥—ã —Å–∏–º—É–ª—è—Ü–∏–∏
 * 
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –∞—Å–ø–µ–∫—Ç–∞–º–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.
 * –Ø–≤–ª—è–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º, –≤—ã–∑—ã–≤–∞–µ–º—ã–º –∏–∑ simulation.js.
 * 
 * @class Environment
 */
export class Environment {
    /**
     * –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Å—Ä–µ–¥—É —Å–∏–º—É–ª—è—Ü–∏–∏
     * 
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç
     * –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤. –ù–µ —Å–æ–∑–¥–∞—ë—Ç –∞–≥–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -
     * –¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å initializePopulations().
     * 
     * @constructor
     */
    constructor() {
        /* === –ú–∞—Å—Å–∏–≤—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏–º—É–ª—è—Ü–∏–∏ === */
        
        /**
         * –ú–∞—Å—Å–∏–≤ —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
         * @type {Herbivore[]}
         */
        this.herbivores = [];
        
        /**
         * –ú–∞—Å—Å–∏–≤ —Ö–∏—â–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤
         * @type {Predator[]}
         */
        this.predators = [];
        
        /**
         * –ú–∞—Å—Å–∏–≤ –µ–¥—ã –Ω–∞ –∫–∞—Ä—Ç–µ
         * @type {Food[]}
         */
        this.food = [];
        
        /**
         * –ú–∞—Å—Å–∏–≤ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π (–Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã)
         * @type {Obstacle[]}
         */
        this.obstacles = [];
        
        /**
         * –ú–∞—Å—Å–∏–≤ —è–¥–æ–≤–∏—Ç—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
         * @type {Poison[]}
         */
        this.poison = [];
        
        /* === –°—á—ë—Ç—á–∏–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ === */
        
        /**
         * –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∂–∏–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤)
         * –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–æ–∂–¥–µ–Ω–∏–∏ –ø–æ—Ç–æ–º–∫–æ–≤ —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º –ø–æ–∫–æ–ª–µ–Ω–∏–µ–º
         * @type {number}
         */
        this.generation = 1;
        
        /**
         * –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—á—ë—Ç—á–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ (–≤ –∫–∞–¥—Ä–∞—Ö)
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: time/60
         * @type {number}
         */
        this.time = 0;
        
        /**
         * –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤ —Å–∏–º—É–ª—è—Ü–∏–∏
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–∞–º–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª—É—á–∞–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ)
         * @type {number}
         */
        this.frameCount = 0;
        
        /**
         * –§–ª–∞–≥ –ø–æ–ª–Ω–æ–≥–æ –≤—ã–º–∏—Ä–∞–Ω–∏—è –ø–æ–ø—É–ª—è—Ü–∏–∏
         * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ true –∫–æ–≥–¥–∞ –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –ø–æ–≥–∏–±–ª–∏
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ –∏ –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
         * @type {boolean}
         */
        this.isExtinct = false;
        
        /* === –§–ª–∞–≥–∏ –≤–∫–ª—é—á–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å—Ä–µ–¥—ã === */
        
        /**
         * –í–∫–ª—é—á–µ–Ω—ã –ª–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
         * –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ–∫–±–æ–∫—Å–æ–º –≤ UI
         * @type {boolean}
         */
        this.obstaclesEnabled = false;
        
        /**
         * –í–∫–ª—é—á—ë–Ω –ª–∏ —è–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
         * –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ–∫–±–æ–∫—Å–æ–º –≤ UI
         * @type {boolean}
         */
        this.poisonEnabled = false;
    }
    
    /* ========================================
       –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–ü–£–õ–Ø–¶–ò–ô
       ======================================== */
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–ø—É–ª—è—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤
     * 
     * –°–æ–∑–¥–∞—ë—Ç —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö –∏ —Ö–∏—â–Ω–∏–∫–æ–≤
     * —Å–æ–≥–ª–∞—Å–Ω–æ CONFIG. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ —Å–±—Ä–æ—Å–µ —Å–∏–º—É–ª—è—Ü–∏–∏.
     * 
     * @returns {void}
     */
    initializePopulations() {
        this.setPopulation('herbivore', CONFIG.agents.herbivore.initialCount);
        this.setPopulation('predator', CONFIG.agents.predator.initialCount);
    }
    
    /**
     * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
     * 
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
     * - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ø—É–ª—è—Ü–∏–π
     * - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ UI (–∫–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å")
     * - –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø–æ–ø—É–ª—è—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é
     * 
     * –ù–æ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö —Å –æ—Ç—Å—Ç—É–ø–æ–º –æ—Ç –∫—Ä–∞—ë–≤ (20px).
     * 
     * @param {string} type - –¢–∏–ø –∞–≥–µ–Ω—Ç–∞: 'herbivore' –∏–ª–∏ 'predator'
     * @param {number} targetCount - –ñ–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≥–µ–Ω—Ç–æ–≤
     * @returns {void}
     * 
     * @example
     * // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 50 —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö:
     * environment.setPopulation('herbivore', 50);
     */
    setPopulation(type, targetCount) {
        const agents = type === 'herbivore' ? this.herbivores : this.predators;
        const AgentClass = type === 'herbivore' ? Herbivore : Predator;
        
        // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > —Ü–µ–ª–µ–≤–æ–≥–æ)
        while (agents.length > targetCount) {
            agents.pop();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ < —Ü–µ–ª–µ–≤–æ–≥–æ)
        while (agents.length < targetCount) {
            // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Å –æ—Ç—Å—Ç—É–ø–æ–º 20px –æ—Ç –∫—Ä–∞—ë–≤
            agents.push(new AgentClass(
                Math.random() * (CONFIG.canvas.width - 40) + 20,
                Math.random() * (CONFIG.canvas.height - 40) + 20
            ));
        }
    }
    
    /* ========================================
       –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–ú–ü–û–ù–ï–ù–¢–û–í –°–†–ï–î–´
       ======================================== */
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
     * 
     * –°–æ–∑–¥–∞—ë—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —ç–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö.
     * –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ä–∞–∑–º–µ—Ä—ã –∑–∞–¥–∞—é—Ç—Å—è –≤ CONFIG.obstacles.
     * 
     * –ï—Å–ª–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã (obstaclesEnabled = false), –æ—á–∏—â–∞–µ—Ç –º–∞—Å—Å–∏–≤.
     * 
     * @returns {void}
     */
    generateObstacles() {
        this.obstacles = [];
        if (!this.obstaclesEnabled) return;
        
        for (let i = 0; i < CONFIG.obstacles.count; i++) {
            // –°–ª—É—á–∞–π–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            const width = CONFIG.obstacles.minSize + 
                         Math.random() * (CONFIG.obstacles.maxSize - CONFIG.obstacles.minSize);
            const height = CONFIG.obstacles.minSize + 
                          Math.random() * (CONFIG.obstacles.maxSize - CONFIG.obstacles.minSize);
            
            // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (—Å —É—á—ë—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è)
            const x = width/2 + Math.random() * (CONFIG.canvas.width - width);
            const y = height/2 + Math.random() * (CONFIG.canvas.height - height);
            
            this.obstacles.push(new Obstacle(x, y, width, height));
        }
    }
    
    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —è–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
     * 
     * –°–æ–∑–¥–∞—ë—Ç —è–¥–æ–≤–∏—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö, –∏–∑–±–µ–≥–∞—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.
     * –î–ª—è –∫–∞–∂–¥–æ–≥–æ —è–¥–∞ –¥–µ–ª–∞–µ—Ç—Å—è –¥–æ 50 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ.
     * 
     * –ï—Å–ª–∏ —è–¥ –æ—Ç–∫–ª—é—á–µ–Ω (poisonEnabled = false), –æ—á–∏—â–∞–µ—Ç –º–∞—Å—Å–∏–≤.
     * 
     * @returns {void}
     */
    generatePoison() {
        this.poison = [];
        if (!this.poisonEnabled) return;
        
        for (let i = 0; i < CONFIG.poison.count; i++) {
            let position;
            let attempts = 0;
            const maxAttempts = 50;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ù–ï –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            do {
                position = new Vector2D(
                    CONFIG.poison.size + Math.random() * (CONFIG.canvas.width - 2 * CONFIG.poison.size),
                    CONFIG.poison.size + Math.random() * (CONFIG.canvas.height - 2 * CONFIG.poison.size)
                );
                attempts++;
            } while (attempts < maxAttempts && this.isInsideObstacle(position.x, position.y));
            
            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ (–Ω–µ –≤ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–∏), —Å–æ–∑–¥–∞—ë–º —è–¥
            if (attempts < maxAttempts) {
                this.poison.push(new Poison(position.x, position.y));
            }
        }
    }
    
    /* ========================================
       –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–ê–ú–ò –°–†–ï–î–´
       ======================================== */
    
    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ
     * 
     * –í–∫–ª—é—á–∞–µ—Ç –∏–ª–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –≤ —Å–∏–º—É–ª—è—Ü–∏–∏.
     * –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏:
     * - –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–æ–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
     * - –£–¥–∞–ª—è–µ—Ç—Å—è –µ–¥–∞ –∏ —è–¥ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
     * - –ê–≥–µ–Ω—Ç—ã, –æ–∫–∞–∑–∞–≤—à–∏–µ—Å—è –≤–Ω—É—Ç—Ä–∏, –≤—ã—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è –Ω–∞—Ä—É–∂—É
     * 
     * –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏:
     * - –í—Å–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è —É–¥–∞–ª—è—é—Ç—Å—è
     * 
     * @param {boolean} enabled - true –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è, false –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è
     * @returns {void}
     */
    toggleObstacles(enabled) {
        this.obstaclesEnabled = enabled;
        this.generateObstacles();
        
        if (enabled) {
            // –£–¥–∞–ª—è–µ–º –µ–¥—É –∏ —è–¥, –æ–∫–∞–∑–∞–≤—à–∏–µ—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            this.food = this.food.filter(f => !this.isInsideObstacle(f.position.x, f.position.y));
            this.poison = this.poison.filter(p => !this.isInsideObstacle(p.position.x, p.position.y));
            
            // –í–´–¢–û–õ–ö–ù–£–¢–¨ –∞–≥–µ–Ω—Ç–æ–≤, –æ–∫–∞–∑–∞–≤—à–∏—Ö—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏–µ –ø—Ä–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ–º –ø–æ—è–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
            [...this.herbivores, ...this.predators].forEach(agent => {
                this.obstacles.forEach(obstacle => {
                    if (obstacle.containsPoint(agent.position.x, agent.position.y)) {
                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∫ –∞–≥–µ–Ω—Ç—É
                        const angle = Math.atan2(
                            agent.position.y - obstacle.position.y,
                            agent.position.x - obstacle.position.x
                        );
                        
                        // –í—ã—Ç–∞–ª–∫–∏–≤–∞–µ–º –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Ä—É–∂—É
                        agent.position.x = obstacle.position.x + 
                                          Math.cos(angle) * (obstacle.radiusX + agent.size + 5);
                        agent.position.y = obstacle.position.y + 
                                          Math.sin(angle) * (obstacle.radiusY + agent.size + 5);
                    }
                });
            });
        }
    }
    
    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —è–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
     * 
     * –í–∫–ª—é—á–∞–µ—Ç –∏–ª–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç —è–¥–æ–≤–∏—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–∏–º—É–ª—è—Ü–∏–∏.
     * –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —è–¥, –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —É–¥–∞–ª—è–µ—Ç –≤–µ—Å—å —è–¥.
     * 
     * @param {boolean} enabled - true –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è, false –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è
     * @returns {void}
     */
    togglePoison(enabled) {
        this.poisonEnabled = enabled;
        this.generatePoison();
    }
    
    /* ========================================
       –°–ü–ê–í–ù –†–ï–°–£–†–°–û–í
       ======================================== */
    
    /**
     * –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –µ–¥—É –Ω–∞ –∫–∞—Ä—Ç–µ
     * 
     * –î–æ–±–∞–≤–ª—è–µ—Ç –µ–¥—É –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è maxCount –∏–∑ CONFIG.
     * –î–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã –µ–¥—ã –¥–µ–ª–∞–µ—Ç—Å—è –¥–æ 50 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é
     * –≤–Ω–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.
     * 
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ –≤ update() –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.
     * 
     * @returns {void}
     */
    spawnFood() {
        // –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –º–µ–Ω—å—à–µ –º–∞–∫—Å–∏–º—É–º–∞
        while (this.food.length < CONFIG.food.maxCount) {
            let position;
            let attempts = 0;
            const maxAttempts = 50;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ù–ï –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
            do {
                position = new Vector2D(
                    Math.random() * CONFIG.canvas.width,
                    Math.random() * CONFIG.canvas.height
                );
                attempts++;
            } while (attempts < maxAttempts && this.isInsideObstacle(position.x, position.y));
            
            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ, —Å–æ–∑–¥–∞—ë–º –µ–¥—É
            if (attempts < maxAttempts) {
                this.food.push(new Food(position.x, position.y));
            }
        }
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
     * 
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–≤–Ω–∞ –µ–¥—ã –∏ —è–¥–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.
     * 
     * @param {number} x - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X —Ç–æ—á–∫–∏
     * @param {number} y - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y —Ç–æ—á–∫–∏
     * @returns {boolean} - true, –µ—Å–ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
     */
    isInsideObstacle(x, y) {
        if (!this.obstaclesEnabled) return false;
        return this.obstacles.some(obstacle => obstacle.containsPoint(x, y));
    }
    
    /* ========================================
       –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–ë–ù–û–í–õ–ï–ù–ò–Ø
       ======================================== */
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–π —Å–∏–º—É–ª—è—Ü–∏–∏ –Ω–∞ –æ–¥–∏–Ω –∫–∞–¥—Ä
     * 
     * –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä –∏–∑ simulation.js.
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤ —Å—Ç—Ä–æ–≥–æ–º –ø–æ—Ä—è–¥–∫–µ:
     * 1. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–æ–≤ –≤—Ä–µ–º–µ–Ω–∏
     * 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ —Ñ–∏–∑–∏–∫–∏ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
     * 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
     * 4. –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –ø–æ–ø—É–ª—è—Ü–∏–∏)
     * 5. –£–¥–∞–ª–µ–Ω–∏–µ –º—ë—Ä—Ç–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ (energy <= 0)
     * 6. –°–ø–∞–≤–Ω –Ω–æ–≤–æ–π –µ–¥—ã
     * 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ–Ω—É –ø–æ–∫–æ–ª–µ–Ω–∏—è –∏ –≤—ã–º–∏—Ä–∞–Ω–∏–µ
     * 
     * @returns {void}
     */
    update() {
        // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–æ–≤
        this.frameCount++;
        this.time++;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤ (—Ç—Ä–∞–≤–æ—è–¥–Ω—ã–µ –∏ —Ö–∏—â–Ω–∏–∫–∏)
        [...this.herbivores, ...this.predators].forEach(agent => {
            // –í—ã–∑–æ–≤ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞ (–∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç + steering behaviors)
            if (agent.type === 'herbivore') {
                agent.behave(this.food, this.predators, this.obstacles, this.poison);
            } else {
                agent.behave(this.herbivores, this.obstacles, this.poison);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–∑–∏–∫–∏ (–ø–æ–∑–∏—Ü–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—è)
            agent.update(this.frameCount);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏
            agent.handleObstacleCollisions(this.obstacles);
        });
        
        // –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –ø–æ–ø—É–ª—è—Ü–∏–∏)
        this.handleReproduction();
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ (—ç–Ω–µ—Ä–≥–∏—è <= 0)
        this.herbivores = this.herbivores.filter(h => !h.isDead());
        this.predators = this.predators.filter(p => !p.isDead());
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –µ–¥—ã (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
        this.spawnFood();
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ –∏ –≤—ã–º–∏—Ä–∞–Ω–∏–µ
        this.nextGeneration();
    }
    
    /* ========================================
       –†–ê–ó–ú–ù–û–ñ–ï–ù–ò–ï –ò –ü–û–ü–£–õ–Ø–¶–ò–û–ù–ù–´–ô –ö–û–ù–¢–†–û–õ–¨
       ======================================== */
    
    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –ø–æ–ø—É–ª—è—Ü–∏–∏
     * 
     * –†–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ–ø—É–ª—è—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤–∑—Ä—ã–≤–∞ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏:
     * 
     * –¢—Ä–∞–≤–æ—è–¥–Ω—ã–µ:
     * - –†–∞–∑–º–Ω–æ–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ø—É–ª—è—Ü–∏—è < 30
     * - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è 30% –∑–∞ –∫–∞–¥—Ä (–ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏)
     * - –ú–∞–∫—Å–∏–º—É–º 5 –Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–º–∫–æ–≤ –∑–∞ –∫–∞–¥—Ä
     * 
     * –•–∏—â–Ω–∏–∫–∏:
     * - –†–∞–∑–º–Ω–æ–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ø—É–ª—è—Ü–∏—è < 15
     * - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è 20% –∑–∞ –∫–∞–¥—Ä (–ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏)
     * - –ú–∞–∫—Å–∏–º—É–º 2 –Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–º–∫–∞ –∑–∞ –∫–∞–¥—Ä
     * 
     * –ü–æ—Å–ª–µ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è this.generation –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ
     * –ø–æ–∫–æ–ª–µ–Ω–∏—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∂–∏–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤.
     * 
     * @returns {void}
     */
    handleReproduction() {
        const newHerbivores = [];
        const newPredators = [];
        
        // –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ø—É–ª—è—Ü–∏—è –º–∞–ª–∞)
        if (this.herbivores.length < 30) {
            this.herbivores.forEach(herbivore => {
                // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å 30% –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è
                if (Math.random() < 0.3) {
                    const offspring = herbivore.reproduce();
                    if (offspring) {
                        newHerbivores.push(offspring);
                    }
                }
            });
        }
        
        // –†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ —Ö–∏—â–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ø—É–ª—è—Ü–∏—è –º–∞–ª–∞)
        if (this.predators.length < 15) {
            this.predators.forEach(predator => {
                // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å 20% –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏—è (–º–µ–Ω—å—à–µ —á–µ–º —É —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö)
                if (Math.random() < 0.2) {
                    const offspring = predator.reproduce();
                    if (offspring) {
                        newPredators.push(offspring);
                    }
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–º–∫–æ–≤ —Å –∂—ë—Å—Ç–∫–∏–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
        // –ú–∞–∫—Å–∏–º—É–º 5 —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö –∏ 2 —Ö–∏—â–Ω–∏–∫–∞ –∑–∞ –∫–∞–¥—Ä
        this.herbivores.push(...newHerbivores.slice(0, 5));
        this.predators.push(...newPredators.slice(0, 2));
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è
        if (newHerbivores.length > 0 || newPredators.length > 0) {
            const allAgents = [...this.herbivores, ...this.predators];
            const maxGen = Math.max(...allAgents.map(a => a.generation));
            if (maxGen > this.generation) {
                this.generation = maxGen;
            }
        }
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –≤—ã–º–∏—Ä–∞–Ω–∏—è –ø–æ–ø—É–ª—è—Ü–∏–∏
     * 
     * –ï—Å–ª–∏ –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –ø–æ–≥–∏–±–ª–∏ (herbivores = 0 –∏ predators = 0),
     * —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ isExtinct = true.
     * 
     * –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
     * - –û—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∏–º—É–ª—è—Ü–∏–∏ –≤ simulation.js
     * - –ü–æ–∫–∞–∑—É —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—ã–º–∏—Ä–∞–Ω–∏–∏
     * - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è
     * 
     * @returns {void}
     */
    nextGeneration() {
        const allAgents = [...this.herbivores, ...this.predators];
        if (allAgents.length === 0) {
            // –í–°–ï –í–´–ú–ï–†–õ–ò - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
            console.warn('üíÄ –ü–æ–ø—É–ª—è—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–º–µ—Ä–ª–∞!');
            this.isExtinct = true;
            return;
        }
    }
    
    /* ========================================
       –î–û–ë–ê–í–õ–ï–ù–ò–ï –ê–ì–ï–ù–¢–û–í –í–†–£–ß–ù–£–Æ
       ======================================== */
    
    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
     * 
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ø—É–ª—è—Ü–∏–∏
     * (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–æ –∫–Ω–æ–ø–∫–æ–π –≤ UI).
     * 
     * @param {string} type - –¢–∏–ø –∞–≥–µ–Ω—Ç–∞: 'herbivore' –∏–ª–∏ 'predator'
     * @returns {void}
     */
    addAgent(type) {
        const x = 20 + Math.random() * (CONFIG.canvas.width - 40);
        const y = 20 + Math.random() * (CONFIG.canvas.height - 40);
        
        if (type === 'herbivore') {
            this.herbivores.push(new Herbivore(x, y));
        } else {
            this.predators.push(new Predator(x, y));
        }
    }
    
    /* ========================================
       –ò–ó–ú–ï–ù–ï–ù–ò–ï –†–ê–ó–ú–ï–†–û–í –ú–ò–†–ê
       ======================================== */
    
    /**
     * –ò–∑–º–µ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –º–∏—Ä–∞ —Å–∏–º—É–ª—è—Ü–∏–∏
     * 
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä—ã canvas –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤,
     * —á—Ç–æ–±—ã –æ–Ω–∏ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ–≤—ã—Ö –≥—Ä–∞–Ω–∏—Ü.
     * –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ —è–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
     * 
     * @param {number} width - –ù–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ canvas
     * @param {number} height - –ù–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ canvas
     * @returns {void}
     */
    resizeWorld(width, height) {
        CONFIG.canvas.width = width;
        CONFIG.canvas.height = height;
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –≤ –≥—Ä–∞–Ω–∏—Ü—ã –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        [...this.herbivores, ...this.predators].forEach(agent => {
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            agent.position.x = Math.min(agent.position.x, width - agent.size);
            agent.position.x = Math.max(agent.position.x, agent.size);
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            agent.position.y = Math.min(agent.position.y, height - agent.size);
            agent.position.y = Math.max(agent.position.y, agent.size);
        });
        
        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π –∏ —è–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        this.generateObstacles();
        this.generatePoison();
    }
    
    /* ========================================
       –°–ë–†–û–° –°–ò–ú–£–õ–Ø–¶–ò–ò
       ======================================== */
    
    /**
     * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–∏–º—É–ª—è—Ü–∏—é –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
     * 
     * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –º–∞—Å—Å–∏–≤—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏ –∏ —Ñ–ª–∞–≥–∏,
     * –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ –ø–æ–ø—É–ª—è—Ü–∏–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã.
     * 
     * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π "–°–±—Ä–æ—Å" –≤ UI.
     * 
     * @returns {void}
     */
    reset() {
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –º–∞—Å—Å–∏–≤–æ–≤
        this.herbivores = [];
        this.predators = [];
        this.food = [];
        this.obstacles = [];
        this.poison = [];
        
        // –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ —Ñ–ª–∞–≥–æ–≤
        this.generation = 1;
        this.time = 0;
        this.frameCount = 0;
        this.isExtinct = false;
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ø—É–ª—è—Ü–∏–π –∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        this.initializePopulations();
        this.spawnFood();
        this.generateObstacles();
        this.generatePoison();
    }
    
    /* ========================================
       –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò
       ======================================== */
    
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏–º—É–ª—è—Ü–∏–∏
     * 
     * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –¥–ª—è:
     * - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
     * - –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ Chart.js
     * - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏
     * 
     * @returns {Object} - –û–±—ä–µ–∫—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
     * @returns {number} return.generation - –¢–µ–∫—É—â–µ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ
     * @returns {number} return.herbivores - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö
     * @returns {number} return.predators - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–∏—â–Ω–∏–∫–æ–≤
     * @returns {number} return.food - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã
     * @returns {number} return.obstacles - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
     * @returns {number} return.poison - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–∞
     * @returns {number} return.time - –í—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
     * @returns {Object} return.avgEnergy - –°—Ä–µ–¥–Ω—è—è —ç–Ω–µ—Ä–≥–∏—è –∞–≥–µ–Ω—Ç–æ–≤
     * @returns {number} return.avgEnergy.herbivores - –°—Ä–µ–¥–Ω—è—è —ç–Ω–µ—Ä–≥–∏—è —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö
     * @returns {number} return.avgEnergy.predators - –°—Ä–µ–¥–Ω—è—è —ç–Ω–µ—Ä–≥–∏—è —Ö–∏—â–Ω–∏–∫–æ–≤
     */
    getStats() {
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —ç–Ω–µ—Ä–≥–∏–∏ —Ç—Ä–∞–≤–æ—è–¥–Ω—ã—Ö
        const herbivoreEnergy = this.herbivores.length > 0 ?
            this.herbivores.reduce((sum, h) => sum + h.energy, 0) / this.herbivores.length : 0;
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —ç–Ω–µ—Ä–≥–∏–∏ —Ö–∏—â–Ω–∏–∫–æ–≤
        const predatorEnergy = this.predators.length > 0 ?
            this.predators.reduce((sum, p) => sum + p.energy, 0) / this.predators.length : 0;
        
        return {
            generation: this.generation,
            herbivores: this.herbivores.length,
            predators: this.predators.length,
            food: this.food.length,
            obstacles: this.obstacles.length,
            poison: this.poison.length,
            time: Math.floor(this.time / 60),  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—ã (60 FPS)
            avgEnergy: {
                herbivores: Math.round(herbivoreEnergy),
                predators: Math.round(predatorEnergy)
            }
        };
    }
    
    /* ========================================
       –û–¢–†–ò–°–û–í–ö–ê
       ======================================== */
    
    /**
     * –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –≤—Å—é —Å–∏–º—É–ª—è—Ü–∏—é –Ω–∞ canvas
     * 
     * –ü–æ—Ä—è–¥–æ–∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (—Å–ª–æ–∏ –æ—Ç –∑–∞–¥–Ω–µ–≥–æ –∫ –ø–µ—Ä–µ–¥–Ω–µ–º—É):
     * 1. –§–æ–Ω (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–º—ã)
     * 2. –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
     * 3. –Ø–¥
     * 4. –ï–¥–∞
     * 5. –ê–≥–µ–Ω—Ç—ã (—Ç—Ä–∞–≤–æ—è–¥–Ω—ã–µ –∏ —Ö–∏—â–Ω–∏–∫–∏)
     * 
     * –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è).
     * 
     * @param {CanvasRenderingContext2D} ctx - –ö–æ–Ω—Ç–µ–∫—Å—Ç canvas –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
     * @param {boolean} showStates - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∞ –Ω–∞–¥ –∞–≥–µ–Ω—Ç–∞–º–∏
     * @returns {void}
     */
    draw(ctx, showStates) {
        // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞ —Å —Ü–≤–µ—Ç–æ–º —Ñ–æ–Ω–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
        const isDark = document.body.getAttribute('data-color-scheme') === 'dark';
        ctx.fillStyle = isDark ? '#1f2121' : '#fcfcf9';
        ctx.fillRect(0, 0, CONFIG.canvas.width, CONFIG.canvas.height);
        
        // –°–õ–û–ô 1: –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è (–Ω–∏–∂–Ω–∏–π —Å–ª–æ–π)
        this.obstacles.forEach(obstacle => obstacle.draw(ctx));
        
        // –°–õ–û–ô 2: –Ø–¥
        this.poison.forEach(poisonItem => poisonItem.draw(ctx));
        
        // –°–õ–û–ô 3: –ï–¥–∞
        this.food.forEach(food => food.draw(ctx));
        
        // –°–õ–û–ô 4: –ê–≥–µ–Ω—Ç—ã (–≤–µ—Ä—Ö–Ω–∏–π —Å–ª–æ–π)
        this.herbivores.forEach(herbivore => herbivore.draw(ctx, showStates));
        this.predators.forEach(predator => predator.draw(ctx, showStates));
    }
}
