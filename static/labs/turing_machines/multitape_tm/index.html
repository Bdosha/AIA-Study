<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏–º—É–ª—è—Ç–æ—Ä –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞</title>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    /* RGB versions for opacity control (Dark Mode) */
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    /* Background color tokens (Dark Mode) */
    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    /* Semantic Color Tokens (Dark Mode) */
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
      inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    /* RGB versions for dark mode */
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

/* Base styles */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*,
*::before,
*::after {
  box-sizing: inherit;
}

/* Typography */
h1,
h2,
h3,
h4,
h5,
h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--line-height-tight);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}

h1 {
  font-size: var(--font-size-4xl);
}
h2 {
  font-size: var(--font-size-3xl);
}
h3 {
  font-size: var(--font-size-2xl);
}
h4 {
  font-size: var(--font-size-xl);
}
h5 {
  font-size: var(--font-size-lg);
}
h6 {
  font-size: var(--font-size-md);
}

p {
  margin: 0 0 var(--space-16) 0;
}

a {
  color: var(--color-primary);
  text-decoration: none;
  transition: color var(--duration-fast) var(--ease-standard);
}

a:hover {
  color: var(--color-primary-hover);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: 500;
  line-height: 1.5;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
  position: relative;
}

.btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.btn--primary {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn--primary:hover {
  background: var(--color-primary-hover);
}

.btn--primary:active {
  background: var(--color-primary-active);
}

.btn--secondary {
  background: var(--color-secondary);
  color: var(--color-text);
}

.btn--secondary:hover {
  background: var(--color-secondary-hover);
}

.btn--secondary:active {
  background: var(--color-secondary-active);
}

.btn--outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.btn--outline:hover {
  background: var(--color-secondary);
}

.btn--sm {
  padding: var(--space-4) var(--space-12);
  font-size: var(--font-size-sm);
  border-radius: var(--radius-sm);
}

.btn--lg {
  padding: var(--space-10) var(--space-20);
  font-size: var(--font-size-lg);
  border-radius: var(--radius-md);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Form elements */
.form-control {
  display: block;
  width: 100%;
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-md);
  line-height: 1.5;
  color: var(--color-text);
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) var(--ease-standard),
    box-shadow var(--duration-fast) var(--ease-standard);
}

select.form-control {
  padding: var(--space-8) var(--space-12);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  background-image: var(--select-caret-light);
  background-repeat: no-repeat;
  background-position: right var(--space-12) center;
  background-size: 16px;
  padding-right: var(--space-32);
}

@media (prefers-color-scheme: dark) {
  select.form-control {
    background-image: var(--select-caret-dark);
  }
}

.form-control:focus {
  border-color: var(--color-primary);
  outline: var(--focus-outline);
}

/* Card component */
.card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.card__body {
  padding: var(--space-16);
}

/* Status indicators */
.status {
  display: inline-flex;
  align-items: center;
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.status--success {
  background-color: rgba(
    var(--color-success-rgb, 33, 128, 141),
    var(--status-bg-opacity)
  );
  color: var(--color-success);
  border: 1px solid
    rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));
}

.status--error {
  background-color: rgba(
    var(--color-error-rgb, 192, 21, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-error);
  border: 1px solid
    rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));
}

.status--warning {
  background-color: rgba(
    var(--color-warning-rgb, 168, 75, 47),
    var(--status-bg-opacity)
  );
  color: var(--color-warning);
  border: 1px solid
    rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));
}

.status--info {
  background-color: rgba(
    var(--color-info-rgb, 98, 108, 113),
    var(--status-bg-opacity)
  );
  color: var(--color-info);
  border: 1px solid
    rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));
}

/* Custom styles for Turing Machine */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-20);
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-24);
    padding: var(--space-16) 0;
    border-bottom: 1px solid var(--color-border);
}

.help-btn {
    position: fixed;
    top: var(--space-20);
    right: var(--space-20);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
    transition: all var(--duration-normal) var(--ease-standard);
}

.help-btn:hover {
    background: var(--color-primary-hover);
    transform: scale(1.1);
}

.wizard {
    margin-bottom: var(--space-32);
}

.wizard-steps {
    display: flex;
    justify-content: center;
    margin-bottom: var(--space-24);
}

.wizard-step {
    display: flex;
    align-items: center;
    margin: 0 var(--space-8);
}

.step-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--color-secondary);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-weight-bold);
    margin-right: var(--space-8);
    transition: all var(--duration-normal) var(--ease-standard);
}

.step-circle.active {
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
}

.step-circle.completed {
    background: var(--color-success);
    color: var(--color-btn-primary-text);
}

.step-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
}

.step-text.active {
    color: var(--color-text);
    font-weight: var(--font-weight-medium);
}

.tape-count-selection {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-16);
    margin-bottom: var(--space-24);
}

.tape-card {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-16);
    text-align: center;
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.tape-card:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-1);
}

.tape-card.selected {
    border-color: var(--color-primary);
    background: var(--color-bg-1);
    box-shadow: var(--shadow-md);
}

.tape-number {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-bottom: var(--space-8);
}

.examples-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-16);
    margin-bottom: var(--space-24);
}

.example-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-16);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.example-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.example-card.selected {
    border-color: var(--color-primary);
    background: var(--color-bg-1);
}

.controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-12);
    align-items: center;
    margin-bottom: var(--space-24);
    padding: var(--space-16);
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
}

.control-group {
    display: flex;
    align-items: center;
    gap: var(--space-8);
}

.status-display {
    padding: var(--space-8) var(--space-16);
    background: var(--color-bg-1);
    border-radius: var(--radius-base);
    font-family: var(--font-family-mono);
    font-size: var(--font-size-sm);
}

.tapes-container {
    margin-bottom: var(--space-24);
}

.tape {
    margin-bottom: var(--space-16);
    padding: var(--space-16);
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
}

.tape-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-12);
}

.tape-cells {
    display: flex;
    gap: var(--space-2);
    overflow-x: auto;
    padding: var(--space-8);
    background: var(--color-background);
    border-radius: var(--radius-base);
    position: relative;
}

.tape-cell {
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    font-family: var(--font-family-mono);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-sm);
    transition: all var(--duration-normal) var(--ease-standard);
    position: relative;
}

.tape-cell.head {
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(var(--color-teal-500-rgb), 0.3);
}

.tape-cell.changed {
    background: var(--color-warning) !important;
    animation: cellChange 0.8s ease-in-out;
    position: relative;
}

.tape-cell.changed::after {
    content: '‚ú®';
    position: absolute;
    top: -10px;
    right: -5px;
    font-size: 12px;
    animation: sparkle 0.8s ease-in-out;
}

@keyframes cellChange {
    0% { transform: scale(1); }
    25% { transform: scale(1.15) rotate(2deg); }
    50% { transform: scale(1.1) rotate(-2deg); }
    75% { transform: scale(1.05) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
}

@keyframes sparkle {
    0% { opacity: 0; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-10px); }
    100% { opacity: 0; transform: translateY(-20px); }
}

.head-tape-1 {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e) !important;
    color: white;
    border: 2px solid #ff6b6b;
    box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.head-tape-2 {
    background: linear-gradient(135deg, #4ecdc4, #7dd3db) !important;
    color: white;
    border: 2px solid #4ecdc4;
    box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
}

.head-tape-3 {
    background: linear-gradient(135deg, #45b7d1, #74c7d9) !important;
    color: white;
    border: 2px solid #45b7d1;
    box-shadow: 0 0 10px rgba(69, 183, 209, 0.5);
}

.head-tape-4 {
    background: linear-gradient(135deg, #f9ca24, #f6d55c) !important;
    color: #2c3e50;
    border: 2px solid #f9ca24;
    box-shadow: 0 0 10px rgba(249, 202, 36, 0.5);
}

.head-tape-5 {
    background: linear-gradient(135deg, #6c5ce7, #8b7ae6) !important;
    color: white;
    border: 2px solid #6c5ce7;
    box-shadow: 0 0 10px rgba(108, 92, 231, 0.5);
}

.tape-cell-index {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
}

.transitions-editor {
    margin-bottom: var(--space-24);
    padding: var(--space-16);
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
}

.transition-rule {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr 2fr 2fr auto;
    gap: var(--space-8);
    align-items: center;
    margin-bottom: var(--space-8);
    padding: var(--space-8);
    background: var(--color-background);
    border-radius: var(--radius-base);
    border: 1px solid transparent;
    transition: all var(--duration-normal) var(--ease-standard);
}

.transition-rule.active {
    border-color: var(--color-primary);
    background: var(--color-bg-1);
    box-shadow: var(--shadow-sm);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    animation: fadeIn 0.3s ease-out;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-50px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: var(--space-20);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: var(--space-20);
}

.close-btn {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    color: var(--color-text-secondary);
    padding: var(--space-4);
    border-radius: var(--radius-base);
    transition: color var(--duration-fast) var(--ease-standard);
}

.close-btn:hover {
    color: var(--color-text);
    background: var(--color-secondary);
}

.help-section {
    margin-bottom: var(--space-24);
}

.help-nav {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-8);
    margin-bottom: var(--space-16);
    padding-bottom: var(--space-16);
    border-bottom: 1px solid var(--color-border);
}

.help-nav-item {
    padding: var(--space-6) var(--space-12);
    background: var(--color-secondary);
    border: none;
    border-radius: var(--radius-base);
    cursor: pointer;
    font-size: var(--font-size-sm);
    color: var(--color-text);
    transition: all var(--duration-normal) var(--ease-standard);
}

.help-nav-item:hover {
    background: var(--color-secondary-hover);
}

.help-nav-item.active {
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
}

.help-content {
    display: none;
}

.help-content.active {
    display: block;
}

.tooltip {
    position: relative;
    cursor: help;
}

.tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-charcoal-800);
    color: var(--color-gray-200);
    padding: var(--space-4) var(--space-8);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-normal) var(--ease-standard);
    z-index: 1000;
}

.tooltip:hover::after {
    opacity: 1;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--color-secondary);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width var(--duration-normal) var(--ease-standard);
}

.notification {
    position: fixed;
    top: var(--space-20);
    right: var(--space-20);
    padding: var(--space-12) var(--space-16);
    border-radius: var(--radius-base);
    color: var(--color-btn-primary-text);
    font-weight: var(--font-weight-medium);
    z-index: 1500;
    transform: translateX(100%);
    transition: transform var(--duration-normal) var(--ease-standard);
}

.notification.show {
    transform: translateX(0);
}

.notification.success {
    background: var(--color-success);
}

.notification.error {
    background: var(--color-error);
}

.notification.warning {
    background: var(--color-warning);
}

.notification.info {
    background: var(--color-info);
}

.btn-icon {
    padding: var(--space-8);
    min-width: 40px;
    height: 40px;
}

.btn-group {
    display: flex;
    gap: var(--space-4);
}

.hidden {
    display: none !important;
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Responsive design */
@media (max-width: 768px) {
    .container {
        padding: var(--space-12);
    }
    
    .controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .transition-rule {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .tape-count-selection {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .examples-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Help Button -->
        <button class="help-btn tooltip" data-tooltip="–ü–æ–º–æ—â—å (H)" onclick="showHelp()" id="helpBtn">
            ?
        </button>

        <!-- Header -->
        <header class="header">
            <div>
                <h1>–°–∏–º—É–ª—è—Ç–æ—Ä –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞</h1>
                <p style="color: var(--color-text-secondary); margin-top: var(--space-8);">
                    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω—ã—Ö –º–∞—à–∏–Ω –¢—å—é—Ä–∏–Ω–≥–∞
                </p>
            </div>
            <div class="status-display" id="globalStatus">
                –ì–æ—Ç–æ–≤ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
            </div>
        </header>

        <!-- Wizard Steps -->
        <div class="wizard" id="wizard">
            <div class="wizard-steps">
                <div class="wizard-step">
                    <div class="step-circle active" id="step1Circle">1</div>
                    <div class="step-text active" id="step1Text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç</div>
                </div>
                <div class="wizard-step">
                    <div class="step-circle" id="step2Circle">2</div>
                    <div class="step-text" id="step2Text">–í—ã–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
                </div>
                <div class="wizard-step">
                    <div class="step-circle" id="step3Circle">3</div>
                    <div class="step-text" id="step3Text">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div class="wizard-step">
                    <div class="step-circle" id="step4Circle">4</div>
                    <div class="step-text" id="step4Text">–°–∏–º—É–ª—è—Ü–∏—è</div>
                </div>
            </div>
        </div>

        <!-- Step 1: Tape Count Selection -->
        <div class="card wizard-step-content" id="step1Content">
            <div class="card__body">
                <h3 style="margin-bottom: var(--space-16);">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç</h3>
                <div class="tape-count-selection">
                    <div class="tape-card" onclick="selectTapeCount(1)" data-count="1">
                        <div class="tape-number">1</div>
                        <div>–û–¥–Ω–∞ –ª–µ–Ω—Ç–∞</div>
                        <small style="color: var(--color-text-secondary);">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–∞—à–∏–Ω–∞</small>
                    </div>
                    <div class="tape-card" onclick="selectTapeCount(2)" data-count="2">
                        <div class="tape-number">2</div>
                        <div>–î–≤–µ –ª–µ–Ω—Ç—ã</div>
                        <small style="color: var(--color-text-secondary);">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</small>
                    </div>
                    <div class="tape-card" onclick="selectTapeCount(3)" data-count="3">
                        <div class="tape-number">3</div>
                        <div>–¢—Ä–∏ –ª–µ–Ω—Ç—ã</div>
                        <small style="color: var(--color-text-secondary);">–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á</small>
                    </div>
                    <div class="tape-card" onclick="selectTapeCount(4)" data-count="4">
                        <div class="tape-number">4</div>
                        <div>–ß–µ—Ç—ã—Ä–µ –ª–µ–Ω—Ç—ã</div>
                        <small style="color: var(--color-text-secondary);">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</small>
                    </div>
                    <div class="tape-card" onclick="selectTapeCount(5)" data-count="5">
                        <div class="tape-number">5</div>
                        <div>–ü—è—Ç—å –ª–µ–Ω—Ç</div>
                        <small style="color: var(--color-text-secondary);">–ú–∞–∫—Å–∏–º—É–º</small>
                    </div>
                </div>
                <div style="text-align: center; margin-top: var(--space-24);">
                    <button class="btn btn--primary btn--lg" onclick="goToStep(2)" id="step1NextBtn" disabled>
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Program Selection -->
        <div class="card wizard-step-content hidden" id="step2Content">
            <div class="card__body">
                <h3 style="margin-bottom: var(--space-16);">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É</h3>
                <div class="examples-grid" id="examplesGrid">
                    <!-- Examples will be populated here -->
                </div>
                <div style="text-align: center; margin-top: var(--space-24); display: flex; gap: var(--space-12); justify-content: center;">
                    <button class="btn btn--outline" onclick="goToStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
                    <button class="btn btn--primary btn--lg" onclick="goToStep(3)" id="step2NextBtn" disabled>
                        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Data Configuration -->
        <div class="card wizard-step-content hidden" id="step3Content">
            <div class="card__body">
                <h3 style="margin-bottom: var(--space-16);">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–µ–Ω—Ç</h3>
                <div id="tapeDataEditor">
                    <!-- Tape editors will be populated here -->
                </div>
                <div style="text-align: center; margin-top: var(--space-24); display: flex; gap: var(--space-12); justify-content: center;">
                    <button class="btn btn--outline" onclick="goToStep(2)">‚Üê –ù–∞–∑–∞–¥</button>
                    <button class="btn btn--primary btn--lg" onclick="goToStep(4)">
                        –ù–∞—á–∞—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Simulation -->
        <div class="wizard-step-content hidden" id="step4Content">
            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <button class="btn btn--primary btn-icon tooltip" data-tooltip="–ó–∞–ø—É—Å–∫/–ü–∞—É–∑–∞ (Space)" onclick="toggleExecution()" id="playBtn">
                        ‚ñ∂Ô∏è
                    </button>
                    <button class="btn btn--secondary btn-icon tooltip" data-tooltip="–û–¥–∏–Ω —à–∞–≥ (‚Üí)" onclick="stepExecution()" id="stepBtn">
                        ‚è≠Ô∏è
                    </button>
                    <button class="btn btn--secondary btn-icon tooltip" data-tooltip="–°–±—Ä–æ—Å (R)" onclick="resetExecution()" id="resetBtn">
                        üîÑ
                    </button>
                </div>
                
                <div class="control-group">
                    <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
                    <select class="form-control" onchange="setSpeed(this.value)" id="speedSelect">
                        <option value="500">–ú–µ–¥–ª–µ–Ω–Ω–æ</option>
                        <option value="200" selected>–ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                        <option value="50">–ë—ã—Å—Ç—Ä–æ</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <button class="btn btn--outline tooltip" data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—É—é —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å" onclick="showEquivalence()" id="equivalenceBtn">
                        üîÑ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
                    </button>
                    <button class="btn btn--outline tooltip" data-tooltip="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é" onclick="showDebugInfo()" id="debugBtn">
                        üîç –û—Ç–ª–∞–¥–∫–∞
                    </button>
                </div>
                
                <div class="status-display" id="machineStatus">
                    –°–æ—Å—Ç–æ—è–Ω–∏–µ: q0 | –®–∞–≥: 0 | –í—Ä–µ–º—è: 0–º—Å
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar" style="margin-bottom: var(--space-16);">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>

            <!-- Tapes Visualization -->
            <div class="tapes-container" id="tapesContainer">
                <!-- Tapes will be rendered here -->
            </div>

            <!-- Transitions Editor -->
            <div class="transitions-editor">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
                    <h4>–ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h4>
                    <button class="btn btn--secondary btn--sm" onclick="addTransition()">
                        + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
                    </button>
                </div>
                <div id="transitionsContainer">
                    <!-- Transition rules will be rendered here -->
                </div>
            </div>

            <!-- Navigation -->
            <div style="text-align: center; margin-top: var(--space-24); display: flex; gap: var(--space-12); justify-content: center;">
                <button class="btn btn--outline" onclick="goToStep(3)">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</button>
                <button class="btn btn--secondary" onclick="saveProgram()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
                </button>
                <button class="btn btn--secondary" onclick="exportLog()">
                    üìÑ –≠–∫—Å–ø–æ—Ä—Ç –∂—É—Ä–Ω–∞–ª–∞
                </button>
            </div>
        </div>

        <!-- Welcome Modal -->
        <div class="modal" id="welcomeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                    <button class="close-btn" onclick="closeWelcome()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞!</p>
                    <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –∏–∑—É—á–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω—ã—Ö –º–∞—à–∏–Ω –¢—å—é—Ä–∏–Ω–≥–∞ –∏ –∏—Ö —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—ã–º –º–∞—à–∏–Ω–∞–º.</p>
                    
                    <h4 style="margin: var(--space-16) 0 var(--space-8) 0;">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:</h4>
                    <ol>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–∞—á–∞—Ç—å —Å 2)</li>
                        <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏"</li>
                        <li>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ª–µ–Ω—Ç</li>
                        <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º</li>
                    </ol>
                    
                    <div style="text-align: center; margin-top: var(--space-24);">
                        <button class="btn btn--primary btn--lg" onclick="closeWelcome()">
                            –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal" id="helpModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <button class="close-btn" onclick="closeHelp()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="help-nav" id="helpNav">
                        <button class="help-nav-item active" onclick="showHelpSection('quickStart')">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</button>
                        <button class="help-nav-item" onclick="showHelpSection('concepts')">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è</button>
                        <button class="help-nav-item" onclick="showHelpSection('interface')">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
                        <button class="help-nav-item" onclick="showHelpSection('program')">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</button>
                        <button class="help-nav-item" onclick="showHelpSection('simulation')">–°–∏–º—É–ª—è—Ü–∏—è</button>
                        <button class="help-nav-item" onclick="showHelpSection('equivalence')">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å</button>
                        <button class="help-nav-item" onclick="showHelpSection('examples')">–ü—Ä–∏–º–µ—Ä—ã</button>
                        <button class="help-nav-item" onclick="showHelpSection('hotkeys')">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</button>
                        <button class="help-nav-item" onclick="showHelpSection('faq')">FAQ</button>
                    </div>
                    
                    <div class="help-content active" id="helpQuickStart">
                        <h3>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h3>
                        <ol>
                            <li><strong>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç</strong> - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –Ω–∞—á–∞—Ç—å —Å 2 –ª–µ–Ω—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤</li>
                            <li><strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–º–µ—Ä</strong> - –≤—ã–±–µ—Ä–∏—Ç–µ "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏" –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</li>
                            <li><strong>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–∞–Ω–Ω—ã–µ</strong> - –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ª–µ–Ω—Ç –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</li>
                            <li><strong>–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é</strong> - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É Play –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–º</li>
                            <li><strong>–ò–∑—É—á–∏—Ç–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å</strong> - –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—É—é</li>
                        </ol>
                        <div class="status status--info" style="margin-top: var(--space-16);">
                            üí° –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∂–∏–º "–ú–µ–¥–ª–µ–Ω–Ω–æ" –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
                        </div>
                    </div>
                    
                    <div class="help-content" id="helpConcepts">
                        <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è</h3>
                        <h4>–ú–∞—à–∏–Ω–∞ –¢—å—é—Ä–∏–Ω–≥–∞</h4>
                        <p>–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, —Å–æ—Å—Ç–æ—è—â–∞—è –∏–∑:</p>
                        <ul>
                            <li><strong>–õ–µ–Ω—Ç–∞</strong> - –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —è—á–µ–µ–∫</li>
                            <li><strong>–ì–æ–ª–æ–≤–∫–∞</strong> - —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é —è—á–µ–π–∫—É</li>
                            <li><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ</strong> - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—à–∏–Ω—ã</li>
                            <li><strong>–ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</strong> - –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–∞—à–∏–Ω—ã</li>
                        </ul>
                        
                        <h4>–ú–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞</h4>
                        <p>–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ –ª–µ–Ω—Ç–∞–º–∏. –ö–∞–∂–¥–∞—è –ª–µ–Ω—Ç–∞ –∏–º–µ–µ—Ç —Å–≤–æ—é –≥–æ–ª–æ–≤–∫—É —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏.</p>
                        
                        <h4>–ü—Ä–∞–≤–∏–ª–æ –ø–µ—Ä–µ—Ö–æ–¥–∞</h4>
                        <p>–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –º–∞—à–∏–Ω—ã: <code>(—Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–∏–º–≤–æ–ª—ã) ‚Üí (–Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ–≤—ã–µ_—Å–∏–º–≤–æ–ª—ã, –¥–≤–∏–∂–µ–Ω–∏—è)</code></p>
                    </div>
                    
                    <div class="help-content" id="helpInterface">
                        <h3>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
                        <h4>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h4>
                        <ul>
                            <li><strong>‚ñ∂Ô∏è Play/Pause</strong> - –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏</li>
                            <li><strong>‚è≠Ô∏è Step</strong> - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞</li>
                            <li><strong>üîÑ Reset</strong> - —Å–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é</li>
                            <li><strong>–°–∫–æ—Ä–æ—Å—Ç—å</strong> - —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</li>
                        </ul>
                        
                        <h4>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–Ω—Ç</h4>
                        <ul>
                            <li><strong>–°–∏–Ω—è—è —è—á–µ–π–∫–∞</strong> - —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≥–æ–ª–æ–≤–∫–∏</li>
                            <li><strong>–ñ–µ–ª—Ç–∞—è —è—á–µ–π–∫–∞</strong> - –Ω–µ–¥–∞–≤–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞</li>
                            <li><strong>–ù–æ–º–µ—Ä–∞ —è—á–µ–µ–∫</strong> - –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏</li>
                        </ul>
                        
                        <h4>–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è</h4>
                        <ul>
                            <li><strong>–ó–µ–ª–µ–Ω—ã–π</strong> - –º–∞—à–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</li>
                            <li><strong>–°–∏–Ω–∏–π</strong> - –º–∞—à–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ</li>
                            <li><strong>–ö—Ä–∞—Å–Ω—ã–π</strong> - –æ—à–∏–±–∫–∞ –∏–ª–∏ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ</li>
                        </ul>
                    </div>
                    
                    <div class="help-content" id="helpProgram">
                        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h3>
                        <h4>–°–æ—Å—Ç–æ—è–Ω–∏—è</h4>
                        <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞: q0 (–Ω–∞—á–∞–ª—å–Ω–æ–µ), q1, q2, qf (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ)</p>
                        
                        <h4>–°–∏–º–≤–æ–ª—ã</h4>
                        <p>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "_" –¥–ª—è –ø—É—Å—Ç–æ–π —è—á–µ–π–∫–∏.</p>
                        
                        <h4>–î–≤–∏–∂–µ–Ω–∏—è –≥–æ–ª–æ–≤–∫–∏</h4>
                        <ul>
                            <li><strong>L</strong> - –≤–ª–µ–≤–æ</li>
                            <li><strong>R</strong> - –≤–ø—Ä–∞–≤–æ</li>
                            <li><strong>S</strong> - –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Å—Ç–µ</li>
                        </ul>
                        
                        <h4>–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞</h4>
                        <code>q0 + [a,_] ‚Üí q1 + [a,a] + [R,R]</code><br>
                        <small>–ò–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è q0, —á–∏—Ç–∞—è 'a' –Ω–∞ –ø–µ—Ä–≤–æ–π –ª–µ–Ω—Ç–µ –∏ '_' –Ω–∞ –≤—Ç–æ—Ä–æ–π, –ø–µ—Ä–µ–π—Ç–∏ –≤ q1, –∑–∞–ø–∏—Å–∞—Ç—å 'a' –Ω–∞ –æ–±–µ –ª–µ–Ω—Ç—ã –∏ —Å–¥–≤–∏–Ω—É—Ç—å –æ–±–µ –≥–æ–ª–æ–≤–∫–∏ –≤–ø—Ä–∞–≤–æ.</small>
                    </div>
                    
                    <div class="help-content" id="helpSimulation">
                        <h3>–ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏</h3>
                        <h4>–ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</h4>
                        <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É Step –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞.</p>
                        
                        <h4>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</h4>
                        <p>–ù–∞–∂–º–∏—Ç–µ Play –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</p>
                        
                        <h4>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h4>
                        <ul>
                            <li>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>
                            <li>–ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è</li>
                            <li>–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ –∞–Ω–∏–º–∏—Ä—É—é—Ç—Å—è</li>
                            <li>–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π</li>
                        </ul>
                    </div>
                    
                    <div class="help-content" id="helpEquivalence">
                        <h3>–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—É—é –º–∞—à–∏–Ω—É</h3>
                        <p>–õ—é–±–∞—è –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ –¢—å—é—Ä–∏–Ω–≥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∞ –≤ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—É—é –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—É—é –º–∞—à–∏–Ω—É.</p>
                        
                        <h4>–ü—Ä–∏–Ω—Ü–∏–ø –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</h4>
                        <ol>
                            <li>–í—Å–µ –ª–µ–Ω—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω—É —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏</li>
                            <li>–ü–æ–∑–∏—Ü–∏–∏ –≥–æ–ª–æ–≤–æ–∫ –æ—Ç–º–µ—á–∞—é—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏</li>
                            <li>–ö–∞–∂–¥—ã–π —à–∞–≥ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã —ç–º—É–ª–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä–∏–µ–π —à–∞–≥–æ–≤ –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π</li>
                        </ol>
                        
                        <h4>–°–ª–æ–∂–Ω–æ—Å—Ç—å</h4>
                        <p>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ, –Ω–æ –≤—ã—á–∏—Å–ª–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
                    </div>
                    
                    <div class="help-content" id="helpExamples">
                        <h3>–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
                        <h4>–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ (2 –ª–µ–Ω—Ç—ã)</h4>
                        <p>–ö–æ–ø–∏—Ä—É–µ—Ç –≤—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–≤–æ–π –ª–µ–Ω—Ç—ã –Ω–∞ –≤—Ç–æ—Ä—É—é. –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏.</p>
                        
                        <h4>–°–ª–æ–∂–µ–Ω–∏–µ —á–∏—Å–µ–ª (3 –ª–µ–Ω—Ç—ã)</h4>
                        <p>–°–∫–ª–∞–¥—ã–≤–∞–µ—Ç –¥–≤–∞ —É–Ω–∞—Ä–Ω—ã—Ö —á–∏—Å–ª–∞. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ—Ç—å–µ–π –ª–µ–Ω—Ç—ã –∫–∞–∫ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.</p>
                        
                        <h4>–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h4>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å:</p>
                        <ul>
                            <li>–û–±—Ä–∞—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏</li>
                            <li>–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞–ª–∏–Ω–¥—Ä–æ–º</li>
                            <li>–£–º–Ω–æ–∂–µ–Ω–∏–µ —á–∏—Å–µ–ª</li>
                            <li>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤</li>
                        </ul>
                    </div>
                    
                    <div class="help-content" id="helpHotkeys">
                        <h3>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h3>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--space-8); font-family: var(--font-family-mono);">
                            <strong>Space</strong> <span>Play/Pause —Å–∏–º—É–ª—è—Ü–∏–∏</span>
                            <strong>‚Üí</strong> <span>–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω —à–∞–≥</span>
                            <strong>R</strong> <span>–°–±—Ä–æ—Å —Å–∏–º—É–ª—è—Ü–∏–∏</span>
                            <strong>H</strong> <span>–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–º–æ—â—å</span>
                            <strong>E</strong> <span>–ü–æ–∫–∞–∑–∞—Ç—å —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å</span>
                            <strong>S</strong> <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</span>
                            <strong>L</strong> <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</span>
                            <strong>Esc</strong> <span>–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞</span>
                        </div>
                    </div>
                    
                    <div class="help-content" id="helpFaq">
                        <h3>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
                        
                        <h4>Q: –ú–∞—à–∏–Ω–∞ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ—Ç—Å—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å?</h4>
                        <p>A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —É—Å–ª–æ–≤–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.</p>
                        
                        <h4>Q: –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ?</h4>
                        <p>A: –ü—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ø–æ–ª–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.</p>
                        
                        <h4>Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã?</h4>
                        <p>A: –î–∞, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω–æ—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.</p>
                        
                        <h4>Q: –ö–∞–∫ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É?</h4>
                        <p>A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É" –∏–ª–∏ –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É S. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.</p>
                        
                        <h4>Q: –ï—Å—Ç—å –ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤?</h4>
                        <p>A: –î–∞, –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏–º–∏—Ç –≤ 10000 —à–∞–≥–æ–≤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification" class="notification"></div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedTapeCount = 0;
        let selectedExample = null;
        let machine = {
            tapes: [],
            states: [],
            currentState: 'q0',
            transitions: [],
            heads: [],
            isRunning: false,
            isPaused: false,
            stepCount: 0,
            startTime: 0
        };
        let executionSpeed = 200;
        let executionTimer = null;
        let maxSteps = 10000;
        
        // Examples data with complete transition rules
        const examples = {
            2: [
                {
                    name: "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏",
                    description: "–ö–æ–ø–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–≤–æ–π –ª–µ–Ω—Ç—ã –Ω–∞ –≤—Ç–æ—Ä—É—é",
                    tapeCount: 2,
                    states: ["q0", "qf"],
                    initialState: "q0",
                    finalStates: ["qf"],
                    alphabet: ["a", "b", "c", "_"],
                    transitions: [
                        { from: "q0", read: ["a", "_"], to: "q0", write: ["a", "a"], move: ["R", "R"], description: "–ö–æ–ø–∏—Ä—É–µ–º 'a'" },
                        { from: "q0", read: ["b", "_"], to: "q0", write: ["b", "b"], move: ["R", "R"], description: "–ö–æ–ø–∏—Ä—É–µ–º 'b'" },
                        { from: "q0", read: ["c", "_"], to: "q0", write: ["c", "c"], move: ["R", "R"], description: "–ö–æ–ø–∏—Ä—É–µ–º 'c'" },
                        { from: "q0", read: ["_", "_"], to: "qf", write: ["_", "_"], move: ["S", "S"], description: "–ö–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è" }
                    ],
                    initialTapes: [["a", "b", "c"], ["_", "_", "_"]]
                },
                {
                    name: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ª–∏–Ω–¥—Ä–æ–º–∞",
                    description: "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–∞–ª–∏–Ω–¥—Ä–æ–º–æ–º",
                    tapeCount: 2,
                    states: ["q0", "q1", "q2", "q3", "q4", "qaccept", "qreject"],
                    initialState: "q0",
                    finalStates: ["qaccept", "qreject"],
                    alphabet: ["a", "b", "_", "X"],
                    transitions: [
                        { from: "q0", read: ["a", "_"], to: "q1", write: ["X", "a"], move: ["R", "R"], description: "–ü–æ–º–µ—á–∞–µ–º 'a' –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º" },
                        { from: "q0", read: ["b", "_"], to: "q2", write: ["X", "b"], move: ["R", "R"], description: "–ü–æ–º–µ—á–∞–µ–º 'b' –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º" },
                        { from: "q0", read: ["_", "_"], to: "qaccept", write: ["_", "_"], move: ["S", "S"], description: "–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –ø–∞–ª–∏–Ω–¥—Ä–æ–º" },
                        { from: "q1", read: ["a", "_"], to: "q1", write: ["a", "_"], move: ["R", "S"], description: "–ò—â–µ–º –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏" },
                        { from: "q1", read: ["b", "_"], to: "q1", write: ["b", "_"], move: ["R", "S"], description: "–ò—â–µ–º –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏" },
                        { from: "q1", read: ["_", "a"], to: "q3", write: ["_", "X"], move: ["L", "L"], description: "–ù–∞—à–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é 'a'" },
                        { from: "q1", read: ["_", "b"], to: "qreject", write: ["_", "b"], move: ["S", "S"], description: "–ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º" },
                        { from: "q2", read: ["a", "_"], to: "q2", write: ["a", "_"], move: ["R", "S"], description: "–ò—â–µ–º –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏" },
                        { from: "q2", read: ["b", "_"], to: "q2", write: ["b", "_"], move: ["R", "S"], description: "–ò—â–µ–º –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏" },
                        { from: "q2", read: ["_", "b"], to: "q3", write: ["_", "X"], move: ["L", "L"], description: "–ù–∞—à–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é 'b'" },
                        { from: "q2", read: ["_", "a"], to: "qreject", write: ["_", "a"], move: ["S", "S"], description: "–ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º" },
                        { from: "q3", read: ["a", "_"], to: "q3", write: ["a", "_"], move: ["L", "S"], description: "–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—á–∞–ª—É" },
                        { from: "q3", read: ["b", "_"], to: "q3", write: ["b", "_"], move: ["L", "S"], description: "–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—á–∞–ª—É" },
                        { from: "q3", read: ["X", "_"], to: "q0", write: ["X", "_"], move: ["R", "S"], description: "–°–ª–µ–¥—É—é—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è" },
                        { from: "q0", read: ["X", "_"], to: "q4", write: ["X", "_"], move: ["R", "S"], description: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã" },
                        { from: "q4", read: ["X", "_"], to: "q4", write: ["X", "_"], move: ["R", "S"], description: "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ" },
                        { from: "q4", read: ["_", "_"], to: "qaccept", write: ["_", "_"], move: ["S", "S"], description: "–í—Å–µ —Å–∏–º–≤–æ–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã - –ø–∞–ª–∏–Ω–¥—Ä–æ–º" }
                    ],
                    initialTapes: [["a", "b", "a"], ["_", "_", "_"]]
                }
            ],
            3: [],
            1: [
                {
                    name: "–ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞",
                    description: "–ó–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã 'a' –Ω–∞ 'b'",
                    tapeCount: 1,
                    states: ["q0", "qf"],
                    initialState: "q0",
                    finalStates: ["qf"],
                    alphabet: ["a", "b", "_"],
                    transitions: [
                        { from: "q0", read: ["a"], to: "q0", write: ["b"], move: ["R"], description: "–ó–∞–º–µ–Ω—è–µ–º 'a' –Ω–∞ 'b'" },
                        { from: "q0", read: ["b"], to: "q0", write: ["b"], move: ["R"], description: "–û—Å—Ç–∞–≤–ª—è–µ–º 'b' –∫–∞–∫ –µ—Å—Ç—å" },
                        { from: "q0", read: ["_"], to: "qf", write: ["_"], move: ["S"], description: "–ö–æ–Ω–µ—Ü –ª–µ–Ω—Ç—ã" }
                    ],
                    initialTapes: [["a", "b", "a", "a"]]
                }
            ]
        };

        function showSimulationTutorial() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üéÜ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ –≤ —Å–∏–º—É–ª—è—Ü–∏–∏</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-16);">
                            <div class="card">
                                <div class="card__body" style="text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: var(--space-8);">‚ñ∂Ô∏è</div>
                                    <h5>–ó–∞–ø—É—Å–∫</h5>
                                    <p style="font-size: var(--font-size-sm);">–ù–∞–∂–º–∏—Ç–µ Play –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card__body" style="text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: var(--space-8);">‚è≠Ô∏è</div>
                                    <h5>–ü–æ —à–∞–≥–∞–º</h5>
                                    <p style="font-size: var(--font-size-sm);">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Step –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card__body" style="text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: var(--space-8);">üéûÔ∏è</div>
                                    <h5>–õ–µ–Ω—Ç—ã</h5>
                                    <p style="font-size: var(--font-size-sm);">–¶–≤–µ—Ç–Ω—ã–µ —Ä–∞–º–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–∑–∏—Ü–∏–∏ –≥–æ–ª–æ–≤–æ–∫</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card__body" style="text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: var(--space-8);">üîÑ</div>
                                    <h5>–ü—Ä–∞–≤–∏–ª–∞</h5>
                                    <p style="font-size: var(--font-size-sm);">–ê–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è –∑–µ–ª—ë–Ω—ã–º</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status status--info" style="margin: var(--space-16) 0;">
                            ‚å®Ô∏è <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong> Space (–∑–∞–ø—É—Å–∫), ‚Üí (—à–∞–≥), R (—Å–±—Ä–æ—Å), H (–ø–æ–º–æ—â—å), E (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å)
                        </div>
                        
                        <div style="text-align: center;">
                            <button class="btn btn--primary" onclick="this.closest('.modal').remove()">
                                –ü–æ–Ω—è—Ç–Ω–æ, –Ω–∞—á–∞—Ç—å! üöÄ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function loadProgram() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const program = JSON.parse(e.target.result);
                        
                        // Validate program structure
                        if (!program.tapeCount || !program.transitions) {
                            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                        }
                        
                        // Load program
                        selectedTapeCount = program.tapeCount;
                        selectedExample = null;
                        
                        machine.states = program.states || [];
                        machine.transitions = program.transitions || [];
                        machine.tapes = program.initialTapes ? program.initialTapes.map(tape => [...tape]) : [];
                        
                        // Ensure we have enough tapes
                        while (machine.tapes.length < selectedTapeCount) {
                            machine.tapes.push(['_']);
                        }
                        
                        machine.heads = new Array(selectedTapeCount).fill(0);
                        machine.currentState = program.initialState || machine.states[0] || 'q0';
                        
                        // Go to simulation step
                        goToStep(4);
                        
                        showNotification(`–ü—Ä–æ–≥—Ä–∞–º–º–∞ "${program.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}" –∑–∞–≥—Ä—É–∂–µ–Ω–∞!`, 'success');
                        
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            showWelcome();
            setupKeyboardShortcuts();
            updateGlobalStatus('–ì–æ—Ç–æ–≤ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞');
            
            // Add load program button to welcome modal
            setTimeout(() => {
                const welcomeModal = document.getElementById('welcomeModal');
                if (welcomeModal && welcomeModal.classList.contains('show')) {
                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'btn btn--outline';
                    loadBtn.innerHTML = 'üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É';
                    loadBtn.onclick = () => { closeWelcome(); loadProgram(); };
                    
                    const buttonContainer = welcomeModal.querySelector('.modal-body > div:last-child');
                    if (buttonContainer) {
                        buttonContainer.appendChild(loadBtn);
                    }
                }
            }, 100);
        });

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (currentStep === 4) toggleExecution();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        if (currentStep === 4) stepExecution();
                        break;
                    case 'KeyR':
                        e.preventDefault();
                        if (currentStep === 4) resetExecution();
                        break;
                    case 'KeyH':
                        e.preventDefault();
                        showHelp();
                        break;
                    case 'KeyE':
                        e.preventDefault();
                        if (currentStep === 4) showEquivalence();
                        break;
                    case 'KeyS':
                        e.preventDefault();
                        if (currentStep === 4) saveProgram();
                        break;
                    case 'Escape':
                        closeHelp();
                        closeWelcome();
                        break;
                }
            });
        }

        // Welcome modal
        function showWelcome() {
            document.getElementById('welcomeModal').classList.add('show');
        }

        function closeWelcome() {
            document.getElementById('welcomeModal').classList.remove('show');
        }

        // Help modal
        function showHelp() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('show');
        }

        function showHelpSection(section) {
            // Update nav
            document.querySelectorAll('.help-nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.help-content').forEach(content => content.classList.remove('active'));
            document.getElementById('help' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
        }

        // Wizard navigation
        function goToStep(step) {
            // Hide current step content
            document.querySelectorAll('.wizard-step-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show target step content
            document.getElementById('step' + step + 'Content').classList.remove('hidden');
            
            // Update wizard steps
            for (let i = 1; i <= 4; i++) {
                const circle = document.getElementById('step' + i + 'Circle');
                const text = document.getElementById('step' + i + 'Text');
                
                circle.classList.remove('active', 'completed');
                text.classList.remove('active');
                
                if (i < step) {
                    circle.classList.add('completed');
                    circle.innerHTML = '‚úì';
                } else if (i === step) {
                    circle.classList.add('active');
                    text.classList.add('active');
                    circle.innerHTML = i;
                } else {
                    circle.innerHTML = i;
                }
            }
            
            currentStep = step;
            
            // Step-specific actions
            if (step === 2) {
                populateExamples();
            } else if (step === 3) {
                setupTapeDataEditor();
            } else if (step === 4) {
                initializeSimulation();
                // Show brief tutorial overlay
                setTimeout(() => showSimulationTutorial(), 500);
            }
            
            updateGlobalStatus(getStepStatus(step));
        }

        function getStepStatus(step) {
            const statuses = {
                1: '–í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ª–µ–Ω—Ç',
                2: '–í—ã–±–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã',
                3: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–µ–Ω—Ç',
                4: '–°–∏–º—É–ª—è—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É'
            };
            return statuses[step] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —à–∞–≥';
        }

        // Step 1: Tape count selection
        function selectTapeCount(count) {
            selectedTapeCount = count;
            
            // Update visual selection
            document.querySelectorAll('.tape-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-count="${count}"]`).classList.add('selected');
            
            // Enable next button
            document.getElementById('step1NextBtn').disabled = false;
            
            showNotification('–í—ã–±—Ä–∞–Ω–æ –ª–µ–Ω—Ç: ' + count, 'info');
        }

        // Step 2: Example selection
        function populateExamples() {
            const grid = document.getElementById('examplesGrid');
            grid.innerHTML = '';
            
            // Add custom program option
            const customCard = document.createElement('div');
            customCard.className = 'example-card';
            customCard.innerHTML = `
                <h4>–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É</h4>
                <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Å –Ω—É–ª—è</p>
                <small style="color: var(--color-text-secondary);">–î–ª—è –æ–ø—ã—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
            `;
            customCard.onclick = () => selectExample(null);
            grid.appendChild(customCard);
            
            // Add examples for selected tape count
            if (examples[selectedTapeCount]) {
                examples[selectedTapeCount].forEach(example => {
                    const card = document.createElement('div');
                    card.className = 'example-card';
                    card.innerHTML = `
                        <h4>${example.name}</h4>
                        <p>${example.description}</p>
                        <small style="color: var(--color-text-secondary);">${example.tapeCount} –ª–µ–Ω—Ç, ${example.transitions.length} –ø—Ä–∞–≤–∏–ª</small>
                    `;
                    card.onclick = () => selectExample(example);
                    grid.appendChild(card);
                });
            }
            
            // Add examples for other tape counts if none for current
            if (!examples[selectedTapeCount] || examples[selectedTapeCount].length === 0) {
                const noExamples = document.createElement('div');
                noExamples.className = 'card';
                noExamples.style.gridColumn = '1 / -1';
                noExamples.innerHTML = `
                    <div class="card__body" style="text-align: center; color: var(--color-text-secondary);">
                        <p>–î–ª—è ${selectedTapeCount} –ª–µ–Ω—Ç –ø–æ–∫–∞ –Ω–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.</p>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç.</p>
                    </div>
                `;
                grid.appendChild(noExamples);
            }
        }

        function selectExample(example) {
            selectedExample = example;
            
            // Update visual selection
            document.querySelectorAll('.example-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.example-card').classList.add('selected');
            
            // Enable next button
            document.getElementById('step2NextBtn').disabled = false;
            
            if (example) {
                showNotification('–í—ã–±—Ä–∞–Ω –ø—Ä–∏–º–µ—Ä: ' + example.name, 'success');
            } else {
                showNotification('–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã', 'info');
            }
        }

        // Step 3: Tape data editor
        function setupTapeDataEditor() {
            const container = document.getElementById('tapeDataEditor');
            container.innerHTML = '';
            
            for (let i = 0; i < selectedTapeCount; i++) {
                const tapeEditor = document.createElement('div');
                tapeEditor.className = 'card';
                tapeEditor.style.marginBottom = 'var(--space-16)';
                
                const initialData = selectedExample ? 
                    (selectedExample.initialTapes[i] || ['_']) : ['_'];
                
                tapeEditor.innerHTML = `
                    <div class="card__body">
                        <h5 style="margin-bottom: var(--space-8); color: ${['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'][i % 5]};">üéûÔ∏è –õ–µ–Ω—Ç–∞ ${i + 1}</h5>
                        <div style="display: flex; gap: var(--space-8); align-items: center; margin-bottom: var(--space-8);">
                            <input type="text" class="form-control" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–∏–º–≤–æ–ª—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä.: a, b, c)" 
                                   value="${initialData.join(', ')}" 
                                   onchange="updateTapeData(${i}, this.value)">
                            <button class="btn btn--secondary btn--sm tooltip" 
                                    data-tooltip="–û—á–∏—Å—Ç–∏—Ç—å –ª–µ–Ω—Ç—É" 
                                    onclick="clearTape(${i})">
                                üóëÔ∏è
                            </button>
                            <button class="btn btn--secondary btn--sm tooltip" 
                                    data-tooltip="–°–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ" 
                                    onclick="generateRandomTape(${i})">
                                üé≤
                            </button>
                        </div>
                        <div class="tape-preview" id="tapePreview${i}">
                            ${initialData.map((symbol, idx) => 
                                `<span class="tape-cell ${idx === 0 ? 'head' : ''}" style="${idx === 0 ? `border-color: ${['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'][i % 5]};` : ''}">${symbol}</span>`
                            ).join('')}
                        </div>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-8);">
                            ‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "_" –¥–ª—è –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫. –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≥–æ–ª–æ–≤–∫–∏: 0
                        </div>
                    </div>
                `;
                
                container.appendChild(tapeEditor);
            }
            
            // Initialize machine tapes
            machine.tapes = [];
            machine.heads = [];
            machine.initialTapes = []; // Store initial configuration
            for (let i = 0; i < selectedTapeCount; i++) {
                const initialData = selectedExample ? 
                    (selectedExample.initialTapes[i] || ['_']) : ['_'];
                machine.tapes.push([...initialData]);
                machine.initialTapes.push([...initialData]);
                machine.heads.push(0);
            }
        }
        
        function generateRandomTape(tapeIndex) {
            const symbols = ['a', 'b', 'c', '1', '0'];
            const length = Math.floor(Math.random() * 5) + 3; // 3-7 symbols
            const randomTape = [];
            
            for (let i = 0; i < length; i++) {
                randomTape.push(symbols[Math.floor(Math.random() * symbols.length)]);
            }
            
            const input = document.querySelector(`#tapeDataEditor .card:nth-child(${tapeIndex + 1}) input`);
            input.value = randomTape.join(', ');
            updateTapeData(tapeIndex, input.value);
            
            showNotification(`–õ–µ–Ω—Ç–∞ ${tapeIndex + 1} –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏`, 'info');
        }
        
        function showDebugInfo() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16);">
                            <div class="card">
                                <div class="card__body">
                                    <h5>‚ö° –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—à–∏–Ω—ã</h5>
                                    <ul style="list-style: none; padding: 0; font-family: var(--font-family-mono);">
                                        <li>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: <code>${machine.currentState}</code></li>
                                        <li>–®–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: <code>${machine.stepCount}</code></li>
                                        <li>–†–∞–±–æ—Ç–∞–µ—Ç: <code>${machine.isRunning ? '–î–∞' : '–ù–µ—Ç'}</code></li>
                                        <li>–ù–∞ –ø–∞—É–∑–µ: <code>${machine.isPaused ? '–î–∞' : '–ù–µ—Ç'}</code></li>
                                        <li>–°–∫–æ—Ä–æ—Å—Ç—å: <code>${executionSpeed}–º—Å</code></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card__body">
                                    <h5>üéûÔ∏è –ü–æ–∑–∏—Ü–∏–∏ –≥–æ–ª–æ–≤–æ–∫</h5>
                                    <ul style="list-style: none; padding: 0; font-family: var(--font-family-mono);">
                                        ${machine.heads.map((pos, i) => 
                                            `<li>–õ–µ–Ω—Ç–∞ ${i+1}: –ø–æ–∑–∏—Ü–∏—è <code>${pos}</code>, —Å–∏–º–≤–æ–ª <code>${machine.tapes[i] ? machine.tapes[i][pos] || '_' : '_'}</code></li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: var(--space-16);">
                            <div class="card__body">
                                <h5>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-8); font-family: var(--font-family-mono);">
                                    <div>–û–±—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: <strong>${machine.states.length}</strong></div>
                                    <div>–û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞: <strong>${machine.transitions.length}</strong></div>
                                    <div>–õ–µ–Ω—Ç—ã: <strong>${selectedTapeCount}</strong></div>
                                    <div>–õ–∏–º–∏—Ç —à–∞–≥–æ–≤: <strong>${maxSteps}</strong></div>
                                    <div>–ê–ª—Ñ–∞–≤–∏—Ç: <strong>${Array.from(new Set(machine.tapes.flat().concat(['_']))).length} —Å–∏–º–≤–æ–ª–æ–≤</strong></div>
                                    <div>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: <strong>${Date.now() - machine.startTime}–º—Å</strong></div>
                                </div>
                            </div>
                        </div>
                        
                        ${machine.executionLog && machine.executionLog.length > 0 ? `
                        <div class="card" style="margin-top: var(--space-16);">
                            <div class="card__body">
                                <h5>üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —à–∞–≥–æ–≤</h5>
                                <div style="max-height: 200px; overflow-y: auto; font-family: var(--font-family-mono); font-size: var(--font-size-sm);">
                                    ${machine.executionLog.slice(-5).map(entry => 
                                        `<div style="padding: var(--space-4); border-bottom: 1px solid var(--color-border);">
                                            <strong>–®–∞–≥ ${entry.step}:</strong> ${entry.rule}<br>
                                            <span style="color: var(--color-text-secondary);">${entry.description || ''}</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="text-align: center; margin-top: var(--space-16);">
                            <button class="btn btn--secondary" onclick="console.log('Machine state:', machine); showNotification('–û–±—ä–µ–∫—Ç machine –≤—ã–≤–µ–¥–µ–Ω –≤ –∫–æ–Ω—Å–æ–ª—å', 'info')">
                                üñ•Ô∏è –í—ã–≤–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateTapeData(tapeIndex, value) {
            const symbols = value.split(',').map(s => s.trim()).filter(s => s !== '');
            if (symbols.length === 0) symbols.push('_');
            
            machine.tapes[tapeIndex] = symbols;
            updateTapePreview(tapeIndex);
        }

        function clearTape(tapeIndex) {
            machine.tapes[tapeIndex] = ['_'];
            const input = document.querySelector(`#tapeDataEditor input:nth-of-type(${tapeIndex * 2 + 1})`);
            input.value = '_';
            updateTapePreview(tapeIndex);
        }

        function updateTapePreview(tapeIndex) {
            const preview = document.getElementById('tapePreview' + tapeIndex);
            const tape = machine.tapes[tapeIndex];
            preview.innerHTML = tape.map((symbol, idx) => 
                `<span class="tape-cell ${idx === 0 ? 'head' : ''}">${symbol}</span>`
            ).join('');
        }

        // Step 4: Simulation
        function initializeSimulation() {
            // Initialize machine state
            if (selectedExample) {
                machine.states = [...selectedExample.states];
                machine.transitions = [...selectedExample.transitions];
                machine.currentState = selectedExample.states[0] || 'q0';
            } else {
                machine.states = ['q0', 'qf'];
                machine.transitions = [];
                machine.currentState = 'q0';
            }
            
            machine.isRunning = false;
            machine.isPaused = false;
            machine.stepCount = 0;
            machine.startTime = Date.now();
            
            // Render interface
            renderTapes();
            renderTransitions();
            updateMachineStatus();
            updateControls();
        }

        function renderTapes() {
            const container = document.getElementById('tapesContainer');
            container.innerHTML = '';
            
            const tapeColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'];
            
            machine.tapes.forEach((tape, index) => {
                const tapeDiv = document.createElement('div');
                tapeDiv.className = 'tape';
                tapeDiv.style.borderLeft = `4px solid ${tapeColors[index % tapeColors.length]}`;
                
                const extendedTape = [...tape];
                // Extend tape if needed
                while (extendedTape.length < machine.heads[index] + 8) {
                    extendedTape.push('_');
                }
                while (machine.heads[index] < 5) {
                    extendedTape.unshift('_');
                    machine.heads[index]++;
                }
                
                machine.tapes[index] = extendedTape;
                
                tapeDiv.innerHTML = `
                    <div class="tape-header">
                        <h5 style="color: ${tapeColors[index % tapeColors.length]};">üéûÔ∏è –õ–µ–Ω—Ç–∞ ${index + 1}</h5>
                        <small>–ü–æ–∑–∏—Ü–∏—è –≥–æ–ª–æ–≤–∫–∏: ${machine.heads[index]} | –°–∏–º–≤–æ–ª–æ–≤: ${extendedTape.filter(s => s !== '_').length}</small>
                    </div>
                    <div class="tape-cells" id="tapeCells${index}">
                        ${extendedTape.map((symbol, cellIndex) => `
                            <div class="tape-cell ${cellIndex === machine.heads[index] ? 'head head-tape-' + (index + 1) : ''}" 
                                 data-tape="${index}" data-cell="${cellIndex}"
                                 style="${cellIndex === machine.heads[index] ? `border-color: ${tapeColors[index % tapeColors.length]}; box-shadow: 0 0 0 2px ${tapeColors[index % tapeColors.length]}40;` : ''}">
                                <div class="tape-cell-index">${cellIndex}</div>
                                <div class="tape-cell-content">${symbol === '_' ? '&nbsp;' : symbol}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(tapeDiv);
            });
            
            // Add validation warnings
            const issues = validateProgram();
            if (issues.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'status status--warning';
                warningDiv.style.margin = 'var(--space-16) 0';
                warningDiv.innerHTML = `
                    ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: ${issues.join(', ')}
                    <button class="btn btn--sm" style="margin-left: var(--space-8);" onclick="showValidationDetails()">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                `;
                container.appendChild(warningDiv);
            }
        }

        function renderTransitions() {
            const container = document.getElementById('transitionsContainer');
            container.innerHTML = '';
            
            if (machine.transitions.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; color: var(--color-text-secondary); padding: var(--space-24);">
                        <p>üìù –ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã</p>
                        <button class="btn btn--primary" onclick="addTransition()">
                            + –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ
                        </button>
                    </div>
                `;
                return;
            }
            
            // Add header with labels
            const headerDiv = document.createElement('div');
            headerDiv.style.display = 'grid';
            headerDiv.style.gridTemplateColumns = '1fr 2fr 1fr 2fr 2fr auto';
            headerDiv.style.gap = 'var(--space-8)';
            headerDiv.style.marginBottom = 'var(--space-8)';
            headerDiv.style.padding = 'var(--space-8)';
            headerDiv.style.fontWeight = 'var(--font-weight-medium)';
            headerDiv.style.fontSize = 'var(--font-size-sm)';
            headerDiv.style.color = 'var(--color-text-secondary)';
            headerDiv.innerHTML = `
                <div>–ò–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>
                <div>–ß–∏—Ç–∞–µ–º —Å–∏–º–≤–æ–ª—ã [${Array.from({length: selectedTapeCount}, (_, i) => `–õ–µ–Ω—Ç–∞ ${i+1}`).join(', ')}]</div>
                <div>–í —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
                <div>–ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–∏–º–≤–æ–ª—ã</div>
                <div>–î–≤–∏–∂–µ–Ω–∏—è –≥–æ–ª–æ–≤–æ–∫ [L/R/S]</div>
                <div>–î–µ–π—Å—Ç–≤–∏—è</div>
            `;
            container.appendChild(headerDiv);
            
            machine.transitions.forEach((transition, index) => {
                const transitionDiv = document.createElement('div');
                transitionDiv.className = 'transition-rule';
                transitionDiv.id = `transition-${index}`;
                
                const isGenerated = transition.description && transition.description.includes('–ê–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ');
                if (isGenerated) {
                    transitionDiv.style.backgroundColor = 'var(--color-bg-2)';
                    transitionDiv.style.opacity = '0.8';
                }
                
                transitionDiv.innerHTML = `
                    <input type="text" class="form-control" value="${transition.from}" 
                           placeholder="q0"
                           onchange="updateTransition(${index}, 'from', this.value)"
                           title="–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ">
                    <input type="text" class="form-control" value="${transition.read.join(', ')}" 
                           placeholder="${Array.from({length: selectedTapeCount}, () => '_').join(', ')}"
                           onchange="updateTransition(${index}, 'read', this.value)"
                           title="–ß–∏—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                    <input type="text" class="form-control" value="${transition.to}" 
                           placeholder="q1"
                           onchange="updateTransition(${index}, 'to', this.value)"
                           title="–¶–µ–ª–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ">
                    <input type="text" class="form-control" value="${transition.write.join(', ')}" 
                           placeholder="${Array.from({length: selectedTapeCount}, () => '_').join(', ')}"
                           onchange="updateTransition(${index}, 'write', this.value)"
                           title="–ó–∞–ø–∏—Å—ã–≤–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                    <input type="text" class="form-control" value="${transition.move.join(', ')}" 
                           placeholder="${Array.from({length: selectedTapeCount}, () => 'S').join(', ')}"
                           onchange="updateTransition(${index}, 'move', this.value)"
                           title="–î–≤–∏–∂–µ–Ω–∏—è –≥–æ–ª–æ–≤–æ–∫: L (–≤–ª–µ–≤–æ), R (–≤–ø—Ä–∞–≤–æ), S (—Å—Ç–æ—è—Ç—å)">
                    <div style="display: flex; gap: var(--space-4);">
                        <button class="btn btn--secondary btn--sm tooltip" 
                                data-tooltip="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ"
                                onclick="duplicateTransition(${index})">
                            üìã
                        </button>
                        <button class="btn btn--secondary btn--sm tooltip" 
                                data-tooltip="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" 
                                onclick="removeTransition(${index})">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                
                // Add description if available
                if (transition.description) {
                    const descDiv = document.createElement('div');
                    descDiv.style.gridColumn = '1 / -1';
                    descDiv.style.fontSize = 'var(--font-size-xs)';
                    descDiv.style.color = 'var(--color-text-secondary)';
                    descDiv.style.fontStyle = 'italic';
                    descDiv.style.marginTop = 'var(--space-4)';
                    descDiv.textContent = 'üí¨ ' + transition.description;
                    transitionDiv.appendChild(descDiv);
                }
                
                container.appendChild(transitionDiv);
            });
        }
        
        function duplicateTransition(index) {
            const original = machine.transitions[index];
            const duplicate = {
                from: original.from,
                read: [...original.read],
                to: original.to,
                write: [...original.write],
                move: [...original.move],
                description: (original.description || '') + ' (–∫–æ–ø–∏—è)'
            };
            
            machine.transitions.splice(index + 1, 0, duplicate);
            renderTransitions();
            showNotification('–ü—Ä–∞–≤–∏–ª–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ', 'info');
        }

        function updateTransition(index, field, value) {
            const transition = machine.transitions[index];
            
            if (field === 'read' || field === 'write' || field === 'move') {
                const values = value.split(',').map(s => s.trim());
                transition[field] = values;
            } else {
                transition[field] = value;
            }
            
            // Update states list if new state added
            if (field === 'from' || field === 'to') {
                if (!machine.states.includes(value)) {
                    machine.states.push(value);
                }
            }
        }

        function addTransition() {
            const newTransition = {
                from: 'q0',
                read: new Array(selectedTapeCount).fill('_'),
                to: 'q1',
                write: new Array(selectedTapeCount).fill('_'),
                move: new Array(selectedTapeCount).fill('S')
            };
            
            machine.transitions.push(newTransition);
            renderTransitions();
        }

        function removeTransition(index) {
            machine.transitions.splice(index, 1);
            renderTransitions();
        }

        // Execution control
        function toggleExecution() {
            if (machine.isRunning) {
                pauseExecution();
            } else {
                startExecution();
            }
        }

        function startExecution() {
            machine.isRunning = true;
            machine.isPaused = false;
            
            executionTimer = setInterval(() => {
                if (!stepExecution()) {
                    pauseExecution();
                }
            }, executionSpeed);
            
            updateControls();
            showNotification('–°–∏–º—É–ª—è—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞', 'success');
        }

        function pauseExecution() {
            machine.isRunning = false;
            machine.isPaused = true;
            
            if (executionTimer) {
                clearInterval(executionTimer);
                executionTimer = null;
            }
            
            updateControls();
            showNotification('–°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'info');
        }

        function stepExecution() {
            if (machine.stepCount >= maxSteps) {
                showNotification('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —à–∞–≥–æ–≤ (10,000)', 'warning');
                pauseExecution();
                return false;
            }
            
            const currentRead = machine.heads.map((head, i) => machine.tapes[i][head] || '_');
            
            // Find matching transition
            const transition = machine.transitions.find(t => 
                t.from === machine.currentState && 
                arraysEqual(t.read, currentRead)
            );
            
            if (!transition) {
                if (machine.currentState === 'qf' || machine.currentState === 'qaccept' || 
                    machine.currentState.includes('f') || machine.currentState.includes('accept')) {
                    showNotification('–ú–∞—à–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    updateMachineStatus('–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    pauseExecution();
                } else if (machine.currentState === 'qreject' || machine.currentState.includes('reject')) {
                    showNotification('–ú–∞—à–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –≤–≤–æ–¥', 'warning');
                    updateMachineStatus('–í–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
                    pauseExecution();
                } else {
                    const errorMsg = `–û—à–∏–±–∫–∞! –ù–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è:\n–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${machine.currentState}\n–ß–∏—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã: [${currentRead.join(', ')}]\n\n–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è ${machine.currentState} + [${currentRead.join(', ')}]`;
                    showDetailedError(errorMsg);
                    updateMachineStatus('–û—à–∏–±–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ');
                    pauseExecution();
                }
                return false;
            }
            
            // Highlight active transition
            highlightTransition(transition);
            
            // Log execution step
            if (!machine.executionLog) machine.executionLog = [];
            machine.executionLog.push({
                step: machine.stepCount,
                timestamp: Date.now() - machine.startTime,
                state: machine.currentState,
                rule: `${transition.from} + [${transition.read.join(', ')}] ‚Üí ${transition.to} + [${transition.write.join(', ')}] + [${transition.move.join(', ')}]`,
                tapes: machine.tapes.map(tape => [...tape]),
                heads: [...machine.heads],
                description: transition.description
            });
            
            // Apply transition
            machine.currentState = transition.to;
            
            // Write symbols and move heads
            transition.write.forEach((symbol, index) => {
                if (index < machine.tapes.length) {
                    machine.tapes[index][machine.heads[index]] = symbol;
                    markCellChanged(index, machine.heads[index]);
                }
            });
            
            transition.move.forEach((direction, index) => {
                if (index < machine.heads.length) {
                    if (direction === 'L') {
                        machine.heads[index] = Math.max(0, machine.heads[index] - 1);
                        if (machine.heads[index] === 0) {
                            machine.tapes[index].unshift('_');
                            machine.heads[index] = 0;
                        }
                    } else if (direction === 'R') {
                        machine.heads[index]++;
                        if (machine.heads[index] >= machine.tapes[index].length) {
                            machine.tapes[index].push('_');
                        }
                    }
                    // 'S' means stay
                }
            });
            
            machine.stepCount++;
            
            // Update display
            renderTapes();
            updateMachineStatus();
            updateProgress();
            
            return true;
        }

        function resetExecution() {
            machine.isRunning = false;
            machine.isPaused = false;
            machine.currentState = machine.states[0] || 'q0';
            machine.stepCount = 0;
            machine.startTime = Date.now();
            machine.executionLog = []; // Reset execution log
            
            // Reset heads
            machine.heads = machine.heads.map(() => 0);
            
            // Reset tapes to initial state
            if (selectedExample) {
                machine.tapes = selectedExample.initialTapes.map(tape => [...tape]);
            } else {
                // Keep the configured initial tapes from step 3
                const initialTapes = machine.initialTapes || machine.tapes.map(() => ['_']);
                machine.tapes = initialTapes.map(tape => [...tape]);
            }
            
            if (executionTimer) {
                clearInterval(executionTimer);
                executionTimer = null;
            }
            
            // Clear transition highlights
            document.querySelectorAll('.transition-rule').forEach(rule => {
                rule.classList.remove('active');
            });
            
            renderTapes();
            updateMachineStatus();
            updateControls();
            updateProgress();
            
            showNotification('–°–∏–º—É–ª—è—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é', 'info');
        }

        function setSpeed(speed) {
            executionSpeed = parseInt(speed);
            
            if (machine.isRunning && executionTimer) {
                clearInterval(executionTimer);
                executionTimer = setInterval(() => {
                    if (!stepExecution()) {
                        pauseExecution();
                    }
                }, executionSpeed);
            }
        }

        // Helper functions
        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }

        function highlightTransition(transition) {
            document.querySelectorAll('.transition-rule').forEach(rule => {
                rule.classList.remove('active');
            });
            
            const transitionIndex = machine.transitions.indexOf(transition);
            if (transitionIndex >= 0) {
                const rule = document.querySelectorAll('.transition-rule')[transitionIndex];
                if (rule) rule.classList.add('active');
            }
        }

        function markCellChanged(tapeIndex, cellIndex) {
            setTimeout(() => {
                const cell = document.querySelector(`[data-tape="${tapeIndex}"][data-cell="${cellIndex}"]`);
                if (cell) {
                    cell.classList.add('changed');
                    cell.style.animation = 'cellChange 0.8s ease-in-out';
                    setTimeout(() => {
                        cell.classList.remove('changed');
                        cell.style.animation = '';
                    }, 800);
                }
            }, 100);
        }
        
        function showValidationDetails() {
            const issues = validateProgram();
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h4>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:</h4>
                        <ul>
                            ${issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                        
                        <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
                        <ul>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π —Å–∏–º–≤–æ–ª–æ–≤</li>
                            <li>–î–æ–±–∞–≤—å—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (qf, qaccept, qreject)</li>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å—Ç–∏–∂–∏–º—ã</li>
                        </ul>
                        
                        <div style="margin-top: var(--space-16);">
                            <button class="btn btn--primary" onclick="generateMissingRules()">
                                ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
                            </button>
                            <button class="btn btn--secondary" onclick="this.closest('.modal').remove()">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateMissingRules() {
            const states = new Set();
            const symbols = new Set(['_']);
            
            // Collect existing states and symbols
            machine.transitions.forEach(t => {
                states.add(t.from);
                states.add(t.to);
                t.read.forEach(s => symbols.add(s));
            });
            
            machine.tapes.forEach(tape => {
                tape.forEach(symbol => symbols.add(symbol));
            });
            
            let addedCount = 0;
            states.forEach(state => {
                if (state.includes('f') || state.includes('accept') || state.includes('reject')) return;
                
                const symbolsArray = Array.from(symbols);
                const combinations = generateCombinations(symbolsArray, selectedTapeCount);
                
                combinations.forEach(combo => {
                    const hasTransition = machine.transitions.some(t => 
                        t.from === state && arraysEqual(t.read, combo)
                    );
                    
                    if (!hasTransition && addedCount < 10) { // Limit to 10 auto-generated rules
                        machine.transitions.push({
                            from: state,
                            read: [...combo],
                            to: 'qf',
                            write: [...combo],
                            move: new Array(selectedTapeCount).fill('S'),
                            description: '–ê–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞)'
                        });
                        addedCount++;
                    }
                });
            });
            
            renderTransitions();
            showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –ø—Ä–∞–≤–∏–ª`, 'success');
            document.querySelector('.modal').remove();
            renderTapes(); // Re-render to update warnings
        }

        function updateMachineStatus(status = null) {
            const statusElement = document.getElementById('machineStatus');
            const elapsed = Date.now() - machine.startTime;
            
            if (status) {
                statusElement.textContent = `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${status}`;
            } else {
                statusElement.textContent = `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${machine.currentState} | –®–∞–≥: ${machine.stepCount} | –í—Ä–µ–º—è: ${elapsed}–º—Å`;
            }
        }

        function updateControls() {
            const playBtn = document.getElementById('playBtn');
            const stepBtn = document.getElementById('stepBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            if (machine.isRunning) {
                playBtn.innerHTML = '‚è∏Ô∏è';
                playBtn.setAttribute('data-tooltip', '–ü–∞—É–∑–∞');
                stepBtn.disabled = true;
            } else {
                playBtn.innerHTML = '‚ñ∂Ô∏è';
                playBtn.setAttribute('data-tooltip', '–ó–∞–ø—É—Å–∫');
                stepBtn.disabled = false;
            }
        }

        function updateProgress() {
            const progress = Math.min((machine.stepCount / maxSteps) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function updateGlobalStatus(status) {
            document.getElementById('globalStatus').textContent = status;
        }

        // Advanced features
        function showEquivalence() {
            const equivalentMachine = convertToSingleTape();
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>üîÑ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–∞—è –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="status status--info" style="margin-bottom: var(--space-16);">
                            ü§ñ –õ—é–±–∞—è ${selectedTapeCount}-–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ –¢—å—é—Ä–∏–Ω–≥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∞ –≤ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—É—é –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω—É—é
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16); margin-bottom: var(--space-24);">
                            <div class="card">
                                <div class="card__body">
                                    <h4>üì¶ –ú–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞</h4>
                                    <ul style="list-style: none; padding: 0;">
                                        <li>üéûÔ∏è –õ–µ–Ω—Ç: ${selectedTapeCount} —à—Ç.</li>
                                        <li>‚öôÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏—è: ${machine.states.length} —à—Ç.</li>
                                        <li>üîÑ –ü–µ—Ä–µ—Ö–æ–¥—ã: ${machine.transitions.length} —à—Ç.</li>
                                        <li>üìù –ê–ª—Ñ–∞–≤–∏—Ç: ${equivalentMachine.alphabet.length} —Å–∏–º–≤–æ–ª–æ–≤</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card__body">
                                    <h4>üì¶ –û–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞</h4>
                                    <ul style="list-style: none; padding: 0;">
                                        <li>üéûÔ∏è –õ–µ–Ω—Ç: 1 —à—Ç.</li>
                                        <li>‚öôÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏—è: ${equivalentMachine.states.length} —à—Ç.</li>
                                        <li>üîÑ –ü–µ—Ä–µ—Ö–æ–¥—ã: ~${equivalentMachine.transitionCount} —à—Ç.</li>
                                        <li>üìù –ê–ª—Ñ–∞–≤–∏—Ç: ${equivalentMachine.alphabet.length} —Å–∏–º–≤–æ–ª–æ–≤</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <h4>üîç –ü—Ä–∏–Ω—Ü–∏–ø –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:</h4>
                        <div class="card" style="background: var(--color-bg-1);">
                            <div class="card__body">
                                <ol style="line-height: 1.6;">
                                    <li><strong>–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–µ–Ω—Ç:</strong> –í—Å–µ ${selectedTapeCount} –ª–µ–Ω—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω—É —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ <code>#</code></li>
                                    <li><strong>–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –≥–æ–ª–æ–≤–æ–∫:</strong> –ü–æ–∑–∏—Ü–∏–∏ –≤—Å–µ—Ö –≥–æ–ª–æ–≤–æ–∫ –æ—Ç–º–µ—á–∞—é—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏</li>
                                    <li><strong>–≠–º—É–ª—è—Ü–∏—è —à–∞–≥–æ–≤:</strong> –ö–∞–∂–¥—ã–π —à–∞–≥ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã —ç–º—É–ª–∏—Ä—É–µ—Ç—Å—è —Å–µ—Ä–∏–µ–π —à–∞–≥–æ–≤</li>
                                    <li><strong>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–∏–º–æ—Å—Ç–∏:</strong> –ö–ª–∞—Å—Å –≤—ã—á–∏—Å–ª–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –∂–µ</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="status status--warning" style="margin-top: var(--space-16);">
                            ‚ö° <strong>–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:</strong> –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤ O(T¬≤) —Ä–∞–∑, –≥–¥–µ T - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã
                        </div>
                        
                        <div style="text-align: center; margin-top: var(--space-24);">
                            <button class="btn btn--primary" onclick="demonstrateEquivalence()">
                                üé¨ –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
                            </button>
                            <button class="btn btn--secondary" onclick="this.closest('.modal').remove()">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function demonstrateEquivalence() {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—à–∏–Ω—ã
    const k = selectedTapeCount;

    // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö –ª–µ–Ω—Ç
    const tapeContents = machine.tapes.map(tape => {
        return tape.join('').trim() || '_';
    });

    // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –æ–¥–Ω–æ–π –ª–µ–Ω—Ç—ã —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
    let singleTapeRepresentation = '';
    for (let i = 0; i < tapeContents.length; i++) {
        const tapeStr = tapeContents[i];
        const headPos = machine.heads[i] || 0;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–µ–Ω—Ç—ã —Å –º–∞—Ä–∫–µ—Ä–æ–º –≥–æ–ª–æ–≤–∫–∏
        for (let j = 0; j < tapeStr.length; j++) {
            if (j === headPos) {
                singleTapeRepresentation += '<span style="background: var(--color-primary); color: white; padding: 2px 4px; border-radius: 2px;">' + 
                    tapeStr[j] + '*</span>';
            } else {
                singleTapeRepresentation += tapeStr[j];
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –ª–µ–Ω—Ç–∞–º–∏
        if (i < tapeContents.length - 1) {
            singleTapeRepresentation += '<span style="color: var(--color-error); font-weight: bold;"> # </span>';
        }
    }

    // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    const demo = document.createElement('div');
    demo.style.marginTop = 'var(--space-16)';
    demo.style.padding = 'var(--space-16)';
    demo.style.background = 'var(--color-bg-3)';
    demo.style.borderRadius = 'var(--radius-base)';
    demo.innerHTML = `
        <h5>üíª –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π –ª–µ–Ω—Ç–µ:</h5>

        <div style="margin: var(--space-16) 0;">
            <h6 style="color: var(--color-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-8);">
                –ò—Å—Ö–æ–¥–Ω–∞—è ${k}-–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞:
            </h6>
            ${tapeContents.map((content, idx) => `
                <div style="font-family: var(--font-family-mono); background: var(--color-surface); 
                     padding: var(--space-8); border-radius: var(--radius-sm); margin: var(--space-4) 0;">
                    <span style="color: var(--color-text-secondary);">–õ–µ–Ω—Ç–∞ ${idx + 1}:</span>
                    <span style="color: var(--color-primary); margin-left: var(--space-8);">${content}</span>
                    <span style="color: var(--color-text-secondary); margin-left: var(--space-8);">
                        (–≥–æ–ª–æ–≤–∫–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ ${machine.heads[idx] || 0})
                    </span>
                </div>
            `).join('')}
        </div>

        <div style="margin: var(--space-16) 0;">
            <h6 style="color: var(--color-text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-8);">
                –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–∞—è –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞:
            </h6>
            <div style="font-family: var(--font-family-mono); background: var(--color-surface); 
                 padding: var(--space-12); border-radius: var(--radius-sm); overflow-x: auto;">
                <div style="color: var(--color-primary); font-weight: var(--font-weight-medium); font-size: var(--font-size-base);">
                    ${singleTapeRepresentation}
                </div>
            </div>
        </div>

        <div style="background: var(--color-bg-1); padding: var(--space-12); border-radius: var(--radius-sm); 
             border-left: 3px solid var(--color-info); margin-top: var(--space-12);">
            <h6 style="margin-bottom: var(--space-8);">üìã –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</h6>
            <ul style="list-style: none; padding: 0; font-size: var(--font-size-sm); line-height: 1.6;">
                <li>üî∑ <code style="background: var(--color-primary); color: white; padding: 2px 6px; border-radius: 2px;">—Å–∏–º–≤–æ–ª*</code> 
                    ‚Äî –ø–æ–∑–∏—Ü–∏—è –≥–æ–ª–æ–≤–∫–∏ (–º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏–º–≤–æ–ª)</li>
                <li>üî∑ <code style="color: var(--color-error); font-weight: bold;">#</code> 
                    ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Ä–∞–∑–Ω—ã—Ö –ª–µ–Ω—Ç</li>
                <li>üî∑ <code>_</code> ‚Äî –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ (blank)</li>
            </ul>
        </div>

        <div style="margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-2); 
             border-radius: var(--radius-sm);">
            <h6 style="margin-bottom: var(--space-8);">‚öôÔ∏è –ê–ª–≥–æ—Ä–∏—Ç–º —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞:</h6>
            <ol style="font-size: var(--font-size-sm); line-height: 1.8; padding-left: var(--space-16);">
                <li><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –ü—Ä–æ–π—Ç–∏ –ª–µ–Ω—Ç—É —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, –∑–∞–ø–æ–º–Ω–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã</li>
                <li><strong>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ:</strong> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–∞ Œ¥ –∫ —Ç–µ–∫—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º —Å–∏–º–≤–æ–ª–∞–º</li>
                <li><strong>–ó–∞–ø–∏—Å—å:</strong> –ü—Ä–æ–π—Ç–∏ –ª–µ–Ω—Ç—É —Å–Ω–æ–≤–∞, –∑–∞–º–µ–Ω–∏—Ç—å –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –Ω–∞ –Ω–æ–≤—ã–µ</li>
                <li><strong>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ:</strong> –°–¥–≤–∏–Ω—É—Ç—å –º–∞—Ä–∫–µ—Ä—ã * —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –¥–≤–∏–∂–µ–Ω–∏—è (L/R/S)</li>
            </ol>
        </div>

        <div style="margin-top: var(--space-12); padding: var(--space-8); background: var(--color-warning-bg); 
             border-left: 3px solid var(--color-warning); border-radius: var(--radius-sm);">
            <span style="font-size: var(--font-size-sm); color: var(--color-text);">
                ‚è±Ô∏è <strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</strong> –ï—Å–ª–∏ ${k}-–ª–µ–Ω—Ç–æ—á–Ω–∞—è –º–∞—à–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ –≤—Ä–µ–º—è T, 
                —Ç–æ –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç O(T¬≤) –≤—Ä–µ–º–µ–Ω–∏
            </span>
        </div>
    `;

    const modalBody = document.querySelector('.modal .modal-body');
    if (modalBody) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        const existingDemo = modalBody.querySelector('.equivalence-demo');
        if (existingDemo) {
            existingDemo.remove();
        }
        demo.className = 'equivalence-demo';
        modalBody.appendChild(demo);
    }
}

        function convertToSingleTape() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–∞—à–∏–Ω—ã
    if (!machine || !machine.transitions || machine.transitions.length === 0) {
        return {
            states: ['q0', 'qaccept', 'qreject'],
            alphabet: ['_', '#', '*'],
            transitionCount: 0,
            error: '–ú–∞—à–∏–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤'
        };
    }

    const k = selectedTapeCount; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ–Ω—Ç
    const states = new Set();
    const alphabet = new Set(['_', '#', '*']); // _ = –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞, # = —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ª–µ–Ω—Ç, * = –º–∞—Ä–∫–µ—Ä –≥–æ–ª–æ–≤–∫–∏

    // –°–æ–±–∏—Ä–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∞–ª—Ñ–∞–≤–∏—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã
    machine.transitions.forEach(trans => {
        states.add(trans.from);
        states.add(trans.to);

        // –°–æ–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        if (trans.read) {
            trans.read.forEach(symbol => {
                if (symbol && symbol !== '_') alphabet.add(symbol);
            });
        }
        if (trans.write) {
            trans.write.forEach(symbol => {
                if (symbol && symbol !== '_') alphabet.add(symbol);
            });
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ–∑–∏—Ü–∏–π –≥–æ–ª–æ–≤–æ–∫)
    const unmarkedSymbols = Array.from(alphabet);
    unmarkedSymbols.forEach(symbol => {
        if (symbol !== '*') {
            alphabet.add(symbol + '*'); // —Å–∏–º–≤–æ–ª —Å –º–∞—Ä–∫–µ—Ä–æ–º –≥–æ–ª–æ–≤–∫–∏
        }
    });

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–π –º–∞—à–∏–Ω—ã –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    // –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã
    const singleTapeStates = new Set();

    states.forEach(state => {
        // –ë–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        singleTapeStates.add(state);

        // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–µ–Ω—Ç—ã (—á—Ç–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–¥ –≥–æ–ª–æ–≤–∫–∞–º–∏)
        for (let i = 0; i <= k; i++) {
            singleTapeStates.add(`${state}_scan_${i}`);
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–Ω—Ç—ã (–∑–∞–ø–∏—Å—å –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥–æ–ª–æ–≤–æ–∫)
        for (let i = 0; i <= k; i++) {
            singleTapeStates.add(`${state}_update_${i}`);
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥–æ–ª–æ–≤–æ–∫ –≤–ª–µ–≤–æ
        for (let i = 0; i <= k; i++) {
            singleTapeStates.add(`${state}_moveleft_${i}`);
        }
    });

    // –û—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã:
    // - O(k*n) —à–∞–≥–æ–≤ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–≥–¥–µ n - —Ä–∞–∑–º–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π —á–∞—Å—Ç–∏ –ª–µ–Ω—Ç—ã)
    // - O(k*n) —à–∞–≥–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    // –í —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ O(k*n) —à–∞–≥–æ–≤ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ —à–∞–≥–∞
    const avgTapeLength = 100; // —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
    const stepsPerTransition = k * avgTapeLength * 3; // scan + update + move
    const estimatedTransitionCount = machine.transitions.length * stepsPerTransition;

    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏
    const conversionInfo = {
        originalStates: states.size,
        originalTapes: k,
        originalTransitions: machine.transitions.length,
        originalAlphabet: unmarkedSymbols.length,

        newStates: singleTapeStates.size,
        newTapes: 1,
        newAlphabet: alphabet.size,
        newTransitions: estimatedTransitionCount,

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–¥–Ω–æ–π –ª–µ–Ω—Ç—ã:
        // [—Å–∏–º–≤–æ–ª_–ª–µ–Ω—Ç—ã1][–º–∞—Ä–∫–µ—Ä?] # [—Å–∏–º–≤–æ–ª_–ª–µ–Ω—Ç—ã2][–º–∞—Ä–∫–µ—Ä?] # ... # [—Å–∏–º–≤–æ–ª_–ª–µ–Ω—Ç—ãk][–º–∞—Ä–∫–µ—Ä?]
        encoding: `–ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –Ω–∞ –æ–¥–Ω–æ–π –ª–µ–Ω—Ç–µ —Å–æ–¥–µ—Ä–∂–∏—Ç k —Ç—Ä–µ–∫–æ–≤:
        - –¢—Ä–µ–∫ i (i=1..k): —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ i-–π –ª–µ–Ω—Ç—ã
        - –°–∏–º–≤–æ–ª —Å * –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –≥–æ–ª–æ–≤–∫–∏ –Ω–∞ —ç—Ç–æ–π –ª–µ–Ω—Ç–µ
        - –°–∏–º–≤–æ–ª # —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–∞–∑–Ω—ã—Ö –ª–µ–Ω—Ç`,

        timeComplexity: `O(T¬≤) –≥–¥–µ T - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã ${k}-–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã`,

        simulationSteps: [
            '1. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏',
            '2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ–π—Ç–∏ –ª–µ–Ω—Ç—É —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, –∑–∞–ø–æ–º–∏–Ω–∞—è —Å–∏–º–≤–æ–ª—ã –ø–æ–¥ –º–∞—Ä–∫–µ—Ä–∞–º–∏',
            '3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞: –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–µ–π—Å—Ç–≤–∏—è',
            '4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–π—Ç–∏ –ª–µ–Ω—Ç—É, –∑–∞–ø–∏—Å—ã–≤–∞—è –Ω–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã',
            '5. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤: —Å–¥–≤–∏–Ω—É—Ç—å –º–∞—Ä–∫–µ—Ä—ã —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –¥–≤–∏–∂–µ–Ω–∏—è',
            '6. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —à–∞–≥–∏ 2-5 –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è'
        ]
    };

    return {
        states: Array.from(singleTapeStates),
        alphabet: Array.from(alphabet),
        transitionCount: estimatedTransitionCount,
        conversionInfo: conversionInfo
    };
}

        function saveProgram() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</label>
                            <input type="text" id="programName" class="form-control" value="–ú–æ—è –º–∞—à–∏–Ω–∞ –¢—å—é—Ä–∏–Ω–≥–∞ ${selectedTapeCount}-–ª–µ–Ω—Ç">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <textarea id="programDescription" class="form-control" rows="2" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞..."></textarea>
                        </div>
                        
                        <div class="card" style="background: var(--color-bg-1); margin: var(--space-16) 0;">
                            <div class="card__body">
                                <h5>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ:</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li>üéûÔ∏è –õ–µ–Ω—Ç: ${selectedTapeCount}</li>
                                    <li>‚öôÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏—è: ${machine.states.length}</li>
                                    <li>üîÑ –ü—Ä–∞–≤–∏–ª–∞: ${machine.transitions.length}</li>
                                    <li>üì¶ –†–∞–∑–º–µ—Ä: ~${JSON.stringify({ tapeCount: selectedTapeCount, states: machine.states, transitions: machine.transitions, initialTapes: machine.tapes.map(tape => [...tape]) }).length} –±–∞–π—Ç</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; gap: var(--space-12); justify-content: center;">
                            <button class="btn btn--primary" onclick="downloadProgram()">
                                üíæ –°–∫–∞—á–∞—Ç—å JSON
                            </button>
                            <button class="btn btn--secondary" onclick="copyToClipboard()">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä
                            </button>
                            <button class="btn btn--outline" onclick="this.closest('.modal').remove()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function downloadProgram() {
            const name = document.getElementById('programName').value || '–ú–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞';
            const description = document.getElementById('programDescription').value;
            
            const program = {
                name: name,
                description: description,
                created: new Date().toISOString(),
                version: '1.0',
                tapeCount: selectedTapeCount,
                states: machine.states,
                initialState: machine.currentState,
                finalStates: machine.states.filter(s => s.includes('f') || s.includes('accept') || s.includes('reject')),
                transitions: machine.transitions.map(t => ({
                    from: t.from,
                    read: [...t.read],
                    to: t.to,
                    write: [...t.write],
                    move: [...t.move],
                    description: t.description || ''
                })),
                initialTapes: machine.tapes.map(tape => [...tape]),
                metadata: {
                    stepCount: machine.stepCount,
                    maxSteps: maxSteps,
                    alphabet: Array.from(new Set(machine.tapes.flat().concat(['_'])))
                }
            };
            
            const dataStr = JSON.stringify(program, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = name.replace(/\s+/g, '_') + '.json';
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification('–ü—Ä–æ–≥—Ä–∞–º–º–∞ "' + name + '" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            document.querySelector('.modal').remove();
        }
        
        function copyToClipboard() {
            const name = document.getElementById('programName').value || '–ú–æ—è –ø—Ä–æ–≥—Ä–∞–º–º–∞';
            const description = document.getElementById('programDescription').value;
            
            const program = {
                name: name,
                description: description,
                tapeCount: selectedTapeCount,
                states: machine.states,
                transitions: machine.transitions,
                initialTapes: machine.tapes.map(tape => [...tape])
            };
            
            navigator.clipboard.writeText(JSON.stringify(program, null, 2)).then(() => {
                showNotification('–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä!', 'success');
                document.querySelector('.modal').remove();
            }).catch(err => {
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
            });
        }

        function exportLog() {
            const executionLog = machine.executionLog || [];
            
            if (executionLog.length === 0) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é!', 'warning');
                return;
            }
            
            const header = ['–®–∞–≥', '–í—Ä–µ–º—è', '–°–æ—Å—Ç–æ—è–Ω–∏–µ', '–ü—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ'];
            
            // Add tape columns
            for (let i = 0; i < selectedTapeCount; i++) {
                header.push(`–õ–µ–Ω—Ç–∞ ${i+1}`, `–ì–æ–ª–æ–≤–∫–∞ ${i+1}`);
            }
            
            const rows = [header];
            
            executionLog.forEach((entry, index) => {
                const row = [
                    index,
                    entry.timestamp,
                    entry.state,
                    entry.rule || '–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ'
                ];
                
                for (let i = 0; i < selectedTapeCount; i++) {
                    row.push(
                        entry.tapes[i] ? entry.tapes[i].join('') : '',
                        entry.heads[i] || 0
                    );
                }
                
                rows.push(row);
            });
            
            const csvContent = rows.map(row => 
                row.map(cell => 
                    typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
                ).join(',')
            ).join('\n');
            
            const dataBlob = new Blob([csvContent], {type: 'text/csv;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `turing_machine_log_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            URL.revokeObjectURL(url);
            showNotification(`–ñ—É—Ä–Ω–∞–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (${executionLog.length} —à–∞–≥–æ–≤)`, 'success');
        }
        
        function takeScreenshot() {
            // Create a canvas to capture the current state
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 1200;
            canvas.height = 800;
            
            // Fill background
            ctx.fillStyle = getComputedStyle(document.body).backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add title
            ctx.fillStyle = getComputedStyle(document.body).color;
            ctx.font = '24px FKGroteskNeue, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('–°–∏–º—É–ª—è—Ç–æ—Ä –º–Ω–æ–≥–æ–ª–µ–Ω—Ç–æ—á–Ω–æ–π –º–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞', canvas.width / 2, 40);
            
            // Add machine state info
            ctx.font = '16px FKGroteskNeue, sans-serif';
            ctx.textAlign = 'left';
            const stateInfo = [
                `–°–æ—Å—Ç–æ—è–Ω–∏–µ: ${machine.currentState}`,
                `–®–∞–≥: ${machine.stepCount}`,
                `–õ–µ–Ω—Ç: ${selectedTapeCount}`,
                `–ü—Ä–∞–≤–∏–ª: ${machine.transitions.length}`,
                `–í—Ä–µ–º—è: ${Date.now() - machine.startTime}–º—Å`
            ];
            
            stateInfo.forEach((info, index) => {
                ctx.fillText(info, 50, 80 + index * 25);
            });
            
            // Add timestamp
            ctx.textAlign = 'right';
            ctx.fillText(new Date().toLocaleString('ru'), canvas.width - 50, 80);
            
            // Draw tapes representation
            let yOffset = 180;
            const tapeColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'];
            
            machine.tapes.forEach((tape, tapeIndex) => {
                // Tape label
                ctx.fillStyle = tapeColors[tapeIndex % tapeColors.length];
                ctx.font = '18px FKGroteskNeue, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`–õ–µ–Ω—Ç–∞ ${tapeIndex + 1}:`, 50, yOffset);
                
                // Draw cells
                const cellWidth = 40;
                const cellHeight = 40;
                const startX = 150;
                const headPos = machine.heads[tapeIndex];
                
                tape.slice(Math.max(0, headPos - 10), headPos + 10).forEach((symbol, cellIndex) => {
                    const actualIndex = Math.max(0, headPos - 10) + cellIndex;
                    const x = startX + cellIndex * (cellWidth + 2);
                    const y = yOffset - 30;
                    
                    // Cell background
                    if (actualIndex === headPos) {
                        ctx.fillStyle = tapeColors[tapeIndex % tapeColors.length];
                    } else {
                        ctx.fillStyle = '#f0f0f0';
                    }
                    ctx.fillRect(x, y, cellWidth, cellHeight);
                    
                    // Cell border
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, cellWidth, cellHeight);
                    
                    // Symbol
                    ctx.fillStyle = actualIndex === headPos ? 'white' : '#333';
                    ctx.font = '16px monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(symbol === '_' ? '‚àÖ' : symbol, x + cellWidth/2, y + cellHeight/2 + 5);
                    
                    // Cell index
                    ctx.fillStyle = '#999';
                    ctx.font = '10px monospace';
                    ctx.fillText(actualIndex.toString(), x + cellWidth/2, y - 5);
                });
                
                yOffset += 80;
            });
            
            // Convert to blob and download
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `turing_machine_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.png`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('–°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
            }, 'image/png');
        }

        // Enhanced error handling
        function showDetailedError(message) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="color: var(--color-error);">‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <pre style="white-space: pre-wrap; font-family: var(--font-family-base); background: var(--color-bg-4); padding: var(--space-16); border-radius: var(--radius-base); margin: var(--space-16) 0;">${message}</pre>
                        <div style="display: flex; gap: var(--space-12); margin-top: var(--space-16);">
                            <button class="btn btn--primary" onclick="suggestAutofix()">
                                üõ†Ô∏è –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                            </button>
                            <button class="btn btn--secondary" onclick="this.closest('.modal').remove()">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function suggestAutofix() {
            const currentRead = machine.heads.map((head, i) => machine.tapes[i][head] || '_');
            const suggestedTransition = {
                from: machine.currentState,
                read: [...currentRead],
                to: 'qf',
                write: [...currentRead],
                move: new Array(selectedTapeCount).fill('S'),
                description: '–ê–≤—Ç–æ-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ'
            };
            
            const confirmMsg = `–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ:\n${suggestedTransition.from} + [${suggestedTransition.read.join(', ')}] ‚Üí ${suggestedTransition.to} + [${suggestedTransition.write.join(', ')}] + [${suggestedTransition.move.join(', ')}]?`;
            
            if (confirm(confirmMsg)) {
                machine.transitions.push(suggestedTransition);
                renderTransitions();
                showNotification('–ü—Ä–∞–≤–∏–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
                document.querySelector('.modal').remove();
            }
        }
        
        function validateProgram() {
            const issues = [];
            const states = new Set();
            const symbols = new Set(['_']);
            
            // Collect states and symbols
            machine.transitions.forEach(t => {
                states.add(t.from);
                states.add(t.to);
                t.read.forEach(s => symbols.add(s));
                t.write.forEach(s => symbols.add(s));
            });
            
            machine.tapes.forEach(tape => {
                tape.forEach(symbol => symbols.add(symbol));
            });
            
            // Check for missing transitions
            let missingCount = 0;
            states.forEach(state => {
                if (state.includes('f') || state.includes('accept') || state.includes('reject')) return;
                
                const symbolsArray = Array.from(symbols);
                const combinations = generateCombinations(symbolsArray, selectedTapeCount);
                
                combinations.forEach(combo => {
                    const hasTransition = machine.transitions.some(t => 
                        t.from === state && arraysEqual(t.read, combo)
                    );
                    
                    if (!hasTransition) {
                        missingCount++;
                    }
                });
            });
            
            if (missingCount > 0) {
                issues.push(`–ù–µ–¥–æ—Å—Ç–∞—ë—Ç ${missingCount} –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ—Ö–æ–¥–æ–≤`);
            }
            
            return issues;
        }
        
        function generateCombinations(symbols, count) {
            if (count === 1) return symbols.map(s => [s]);
            
            const result = [];
            const smaller = generateCombinations(symbols, count - 1);
            
            symbols.forEach(symbol => {
                smaller.forEach(combo => {
                    result.push([symbol, ...combo]);
                });
            });
            
            return result;
        }

        // Enhanced notifications
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = `notification ${type} show`;
            
            // Auto-hide after different times based on type
            const hideTime = type === 'error' ? 5000 : type === 'warning' ? 4000 : 3000;
            setTimeout(() => {
                notification.classList.remove('show');
            }, hideTime);
        }
    </script>
</body>
</html>